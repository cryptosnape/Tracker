<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stempel v17.15 - Debug Edition</title>
    <style>
        :root {
            --primary: #218d8f;
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #000;
            --success: #34c759;
            --danger: #ff3b30;
            --warning: #ff9500;
            --info: #007aff;
            --gray: #8e8e93;
            --office: #4a90e2;
            --drive: #ff8c42;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 80px;
            user-select: none;
        }

        .header {
            background: var(--card);
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .time-big {
            font-size: 42px;
            font-weight: 700;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .date-small {
            font-size: 11px;
            color: var(--gray);
            margin-top: 3px;
        }

        .sync-status {
            font-size: 10px;
            color: var(--gray);
            margin-top: 4px;
        }

        .page {
            display: none;
            padding: 16px;
            animation: fadeIn 0.2s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h2 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        button {
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            padding: 12px 16px;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-blue { background: var(--info); color: white; }
        .btn-gray { background: #e5e5ea; color: #000; }
        .btn-orange { background: var(--warning); color: white; }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 8px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f9f9fb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--primary);
        }

        .stat-value.positive { color: var(--success); }
        .stat-value.negative { color: var(--danger); }

        .stamp-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stamp-btn {
            padding: 20px 16px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 0;
            width: 100%;
        }

        .stamp-btn .icon { font-size: 32px; }
        .stamp-btn:active { transform: scale(0.96); }

        .stamp-btn.office { background: linear-gradient(135deg, #6ba3d4 0%, #4a90e2 100%); }
        .stamp-btn.drive { background: linear-gradient(135deg, #ffb366 0%, #ff8c42 100%); }
        .stamp-btn.inactive { background: #e0e0e0; color: #666; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stamp-btn.active.office { background: linear-gradient(135deg, #4a90e2 0%, #2e5a99 100%); box-shadow: 0 0 20px rgba(74, 144, 226, 0.5), 0 4px 12px rgba(0,0,0,0.15); }
        .stamp-btn.active.drive { background: linear-gradient(135deg, #ff8c42 0%, #dd5c1d 100%); box-shadow: 0 0 20px rgba(255, 140, 66, 0.5), 0 4px 12px rgba(0,0,0,0.15); }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .control-btn {
            padding: 14px 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            margin-bottom: 0;
            width: 100%;
        }

        .control-btn .icon { font-size: 24px; }

        .btn-pause { background: #fff3e0; color: var(--drive); border: 2px solid rgba(255, 140, 66, 0.3); }
        .btn-pause:active { transform: scale(0.96); background: var(--drive); color: white; border-color: var(--drive); }
        .btn-pause.break { background: var(--warning); color: white; border-color: var(--warning); }

        .btn-stop { background: #fee2e2; color: var(--danger); border: 2px solid rgba(255, 59, 48, 0.3); }
        .btn-stop:active { transform: scale(0.96); background: var(--danger); color: white; border-color: var(--danger); }

        .control-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

        .status-area { text-align: center; margin: 12px 0; }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.office { background: rgba(74, 144, 226, 0.2); color: var(--office); }
        .status-badge.drive { background: rgba(255, 140, 66, 0.2); color: var(--drive); }
        .status-badge.inactive { background: #f0f0f0; color: #999; }

        .account-highlight {
            background: linear-gradient(135deg, rgba(33, 141, 143, 0.05) 0%, rgba(52, 199, 89, 0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .account-title { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px; }

        .account-value {
            font-size: 44px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 12px;
        }

        .account-value.positive { color: var(--success); }
        .account-value.negative { color: var(--danger); }

        .account-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .account-info-item {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .account-info-label { font-size: 10px; color: var(--gray); margin-bottom: 4px; }
        .account-info-value { font-size: 16px; font-weight: 700; color: var(--primary); }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            height: 70px;
            z-index: 200;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: var(--gray);
            cursor: pointer;
        }

        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 22px; margin-bottom: 2px; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 14px;
            padding: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
            font-family: monospace;
        }

        textarea { font-size: 12px; min-height: 60px; resize: vertical; }
        label { display: block; font-size: 12px; color: var(--gray); margin-top: 12px; font-weight: 500; }

        .info-box { background: #e3f2fd; border: 1px solid #90caf9; color: #1565c0; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 15px; }
        .success-box { background: #dcfce7; border: 1px solid #86efac; color: #166534; padding: 10px; border-radius: 8px; font-size: 12px; }
        .error-box { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 10px; border-radius: 8px; font-size: 12px; }
        .warning-box { background: #fef3c7; border: 1px solid #fcd34d; color: #b45309; padding: 10px; border-radius: 8px; font-size: 12px; }

        .debug-log {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 12px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .debug-log-line { padding: 2px 0; }
        .debug-log-error { color: #ff4444; }
        .debug-log-success { color: #44ff44; }
        .debug-log-warning { color: #ffaa00; }
        .debug-log-info { color: #88ddff; }

        .small { font-size: 12px; color: var(--gray); }
        #localBackupFile { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="time-big" id="clock">00:00</div>
        <div class="date-small" id="dateDisplay">Montag</div>
        <div class="sync-status" id="syncStatus">‚òÅÔ∏è Bereit</div>
    </div>

    <div id="page-work" class="page active">
        <div class="account-highlight">
            <div class="account-title">üìä Arbeitszeitkonto</div>
            <div class="account-value" id="cumulativeValue">+0:00</div>
            <div class="account-info">
                <div class="account-info-item">
                    <div class="account-info-label">Heute</div>
                    <div class="account-info-value" id="accountToday">0:00</div>
                </div>
                <div class="account-info-item">
                    <div class="account-info-label">Arbeitstage</div>
                    <div class="account-info-value" id="workdaysCount">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="stamp-buttons">
                <button class="stamp-btn office inactive" id="stampOfficeBtn" onclick="app.startOrSwitch('office')">
                    <span class="icon">üè¢</span>
                    <span>B√ºro</span>
                </button>
                <button class="stamp-btn drive inactive" id="stampDriveBtn" onclick="app.startOrSwitch('drive')">
                    <span class="icon">üöó</span>
                    <span>Fahrt</span>
                </button>
            </div>

            <div class="status-area" id="statusArea"></div>

            <div class="control-grid">
                <button class="control-btn btn-pause" onclick="app.toggleBreak()" id="pauseBtn">
                    <span class="icon" id="pauseIcon">‚òï</span>
                    <span class="control-label" id="pauseText">Pause</span>
                </button>
                <button class="control-btn btn-stop" onclick="app.finishSession()">
                    <span class="icon">‚èπÔ∏è</span>
                    <span class="control-label">Stopp</span>
                </button>
            </div>
        </div>

        <div class="card">
            <h2>üìÖ Heute</h2>
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-label">Arbeitszeit</div>
                    <div class="stat-value" id="statToday">0:00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">vs. Soll</div>
                    <div class="stat-value" id="statDiff">0:00</div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="card">
            <h2>‚òÅÔ∏è Supabase Sync (v17.15)</h2>
            <div id="syncStatus2" class="error-box">‚ö†Ô∏è Nicht verbunden</div>
            <button class="btn-green" onclick="app.showSupabaseWizard()">üîß Einrichten</button>
            <button class="btn-orange" onclick="app.testSupabase()" style="margin-top: 5px;">üß™ Test</button>
            <button class="btn-gray" onclick="app.disconnectSupabase()" style="margin-top: 5px;">Trennen</button>
        </div>

        <div class="card">
            <h2>üîç Debug-Panel</h2>
            <button class="btn-blue" onclick="app.toggleDebugPanel()" style="margin-bottom: 5px;">üìä Debug-Infos anzeigen</button>
            <div id="debugPanel" style="display: none;">
                <div class="debug-log" id="debugLog"></div>
                <button class="btn-gray" onclick="app.clearDebugLog()">üóëÔ∏è Log l√∂schen</button>
                <button class="btn-gray" onclick="app.exportDebugLog()" style="margin-top: 5px;">üì• Log exportieren</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <label>Sollstunden pro Tag</label>
            <input type="number" id="cfgTarget" value="7.8" step="0.1" min="0" max="24">
            <button class="btn-green" onclick="app.saveSettings()" style="margin-top: 15px;">üíæ Speichern</button>
        </div>
    </div>

    <div id="supabaseWizard" class="modal">
        <div class="modal-content">
            <h2>üîê Supabase Verbindung</h2>
            <p class="info-box"><strong>1. Gehe zu supabase.com<br>2. Dein Projekt<br>3. Settings ‚Üí API<br>4. URL + Key kopieren<br>5. Hier einf√ºgen</strong></p>
            <label>Project URL</label>
            <input type="text" id="supabaseUrl" placeholder="https://xxxx.supabase.co">
            <label>Anon Key</label>
            <textarea id="supabaseKey" placeholder="eyJhbGc..."></textarea>
            <button class="btn-green" onclick="app.saveSupabaseSettings()" style="margin-top: 10px;">‚úÖ Verbinden</button>
            <button class="btn-gray" onclick="app.closeSupabaseWizard()">Abbrechen</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="app.nav('work')"><span class="nav-icon">‚è±Ô∏è</span>Arbeit</div>
        <div class="nav-item" onclick="app.nav('settings')"><span class="nav-icon">‚öôÔ∏è</span>Setup</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const STORAGE_KEY = 'stempel_v17_data';
        const GLOBAL_USER_ID = 'main_user';
        const hessenHolidays = ['2025-01-01', '2025-04-18', '2025-04-21', '2025-05-01', '2025-05-29', '2025-06-09', '2025-06-19', '2025-10-03', '2025-12-25', '2025-12-26'];

        const app = {
            data: {
                daily: {},
                spesen: [],
                config: { targetHours: 7.8, startBalance: 0, supabaseUrl: null, supabaseKey: null }
            },
            state: {
                currentMode: null,
                isOnBreak: false,
                isSyncing: false,
                actionLocked: false,
                deviceId: null,
                lastSyncTime: null,
                supabaseClient: null,
                debugLog: [],
                debugPanelOpen: false
            },

            log(type, msg) {
                const timestamp = new Date().toLocaleTimeString('de-DE');
                const logEntry = `[${timestamp}] ${msg}`;
                this.state.debugLog.push({ type, msg: logEntry });
                if (this.state.debugLog.length > 100) this.state.debugLog.shift();
                this.updateDebugDisplay();
                console.log(`[${type}] ${msg}`);
            },

            init() {
                this.log('info', '=== Stempel v17.15 Init ===');
                this.load();
                this.setupDeviceId();
                this.setupSupabase();
                this.reconstructStateFromToday();
                this.updateTime();
                setInterval(() => this.updateTime(), 500);
                setInterval(() => this.syncWithSupabase(), 3000);

                document.getElementById('cfgTarget').value = this.data.config.targetHours;
                this.updateSyncStatus();
                this.updateUI();
                this.log('success', 'App bereit');
            },

            setupDeviceId() {
                let deviceId = localStorage.getItem('stempel_device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('stempel_device_id', deviceId);
                }
                this.state.deviceId = deviceId;
                this.log('info', `Lokale Ger√§te-ID: ${deviceId}`);
            },

            setupSupabase() {
                if (this.data.config.supabaseUrl && this.data.config.supabaseKey) {
                    try {
                        this.state.supabaseClient = window.supabase.createClient(
                            this.data.config.supabaseUrl,
                            this.data.config.supabaseKey
                        );
                        this.log('success', 'Supabase Client erstellt');
                    } catch (e) {
                        this.log('error', `Supabase Init Fehler: ${e.message}`);
                    }
                }
            },

            save() {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); } catch (e) { this.log('error', `Save Fehler: ${e.message}`); }
            },

            load() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (raw) this.data = JSON.parse(raw);
                } catch (e) { this.log('error', `Load Fehler: ${e.message}`); }
            },

            getLocalDateKey(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            },

            reconstructStateFromToday() {
                const todayKey = this.getLocalDateKey(new Date());
                const day = this.data.daily[todayKey];
                this.state.currentMode = null;
                this.state.isOnBreak = false;
                if (!day || !day.entries || !day.entries.length) return;

                day.entries.sort((a, b) => a.time.localeCompare(b.time));
                const last = day.entries[day.entries.length - 1];

                if (last.type === 'office' || last.type === 'drive') {
                    this.state.currentMode = last.type;
                    this.state.isOnBreak = false;
                } else if (last.type === 'breakstart') {
                    this.state.isOnBreak = true;
                    for (let i = day.entries.length - 2; i >= 0; i--) {
                        if (day.entries[i].type === 'office' || day.entries[i].type === 'drive') {
                            this.state.currentMode = day.entries[i].type;
                            break;
                        }
                    }
                }
            },

            updateTime() {
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('clock').innerText = `${h}:${m}`;

                const opts = { weekday: 'short' };
                document.getElementById('dateDisplay').innerText = now.toLocaleDateString('de-DE', opts);

                this.updateUI();
            },

            updateUI() {
                this.updateButtonStates();
                this.updateStatusDisplay();
                this.calc();
                this.updateAccountDisplay();
            },

            updateButtonStates() {
                const officeBtn = document.getElementById('stampOfficeBtn');
                const driveBtn = document.getElementById('stampDriveBtn');

                officeBtn.classList.remove('active', 'inactive');
                driveBtn.classList.remove('active', 'inactive');

                if (this.state.currentMode === 'office') {
                    officeBtn.classList.add('active');
                    driveBtn.classList.add('inactive');
                } else if (this.state.currentMode === 'drive') {
                    officeBtn.classList.add('inactive');
                    driveBtn.classList.add('active');
                } else {
                    officeBtn.classList.add('inactive');
                    driveBtn.classList.add('inactive');
                }
            },

            updateStatusDisplay() {
                const todayKey = this.getLocalDateKey(new Date());
                const day = this.data.daily[todayKey];
                let statusHtml = '';

                if (this.state.currentMode === 'office') {
                    statusHtml += '<span class="status-badge office">üè¢ IM B√úRO</span>';
                } else if (this.state.currentMode === 'drive') {
                    statusHtml += '<span class="status-badge drive">üöó IN FAHRT</span>';
                } else {
                    statusHtml += '<span class="status-badge inactive">‚è∫Ô∏è Bereit</span>';
                }

                if (this.state.isOnBreak) {
                    statusHtml += '<span style="display: inline-block; margin-left: 8px; padding: 6px 12px; background: var(--warning); color: white; border-radius: 8px; font-size: 11px; font-weight: 700;">‚òï PAUSE</span>';
                }

                document.getElementById('statusArea').innerHTML = statusHtml;
            },

            startOrSwitch(mode) {
                if (this.state.actionLocked) return;
                this.state.actionLocked = true;
                setTimeout(() => { this.state.actionLocked = false; }, 400);

                if (!this.state.currentMode) {
                    this.startWith(mode);
                } else if (this.state.currentMode !== mode) {
                    this.switchToMode(mode);
                }
            },

            startWith(mode) {
                const today = this.getLocalDateKey(new Date());
                if (!this.data.daily[today]) this.data.daily[today] = { entries: [] };

                const now = new Date();
                const timeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

                this.data.daily[today].entries.push({ type: mode, time: timeStr });
                this.state.currentMode = mode;
                this.state.isOnBreak = false;
                this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));

                this.log('success', `${mode} gestartet`);
                this.save();
                this.syncToSupabase();
                this.updateUI();
            },

            switchToMode(newMode) {
                if (!this.state.currentMode || this.state.currentMode === newMode) return;

                const today = this.getLocalDateKey(new Date());
                if (!this.data.daily[today]) this.data.daily[today] = { entries: [] };

                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                const s2 = String((now.getSeconds() + 1) % 60).padStart(2, '0');

                const timeStr1 = `${today}T${h}:${m}:${s}`;
                const timeStr2 = `${today}T${h}:${m}:${s2}`;

                if (this.state.isOnBreak) {
                    this.data.daily[today].entries.push({ type: 'breakend', time: timeStr1 });
                    this.state.isOnBreak = false;
                }

                this.data.daily[today].entries.push({ type: 'back', time: timeStr1 });
                this.data.daily[today].entries.push({ type: newMode, time: timeStr2 });

                this.state.currentMode = newMode;
                this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));

                this.log('success', `Gewechselt zu ${newMode}`);
                this.save();
                this.syncToSupabase();
                this.updateUI();
            },

            toggleBreak() {
                if (this.state.actionLocked) return;
                this.state.actionLocked = true;
                setTimeout(() => { this.state.actionLocked = false; }, 400);

                if (!this.state.currentMode) return;

                const today = this.getLocalDateKey(new Date());
                if (!this.data.daily[today]) this.data.daily[today] = { entries: [] };

                const now = new Date();
                const timeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

                const type = this.state.isOnBreak ? 'breakend' : 'breakstart';
                this.data.daily[today].entries.push({ type, time: timeStr });
                this.state.isOnBreak = !this.state.isOnBreak;
                this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));

                this.log('info', `Pause ${this.state.isOnBreak ? 'gestartet' : 'beendet'}`);
                this.save();
                this.syncToSupabase();
                this.updateUI();
            },

            finishSession() {
                if (this.state.actionLocked) return;
                this.state.actionLocked = true;
                setTimeout(() => { this.state.actionLocked = false; }, 400);

                if (!this.state.currentMode) return;

                const today = this.getLocalDateKey(new Date());
                if (!this.data.daily[today]) this.data.daily[today] = { entries: [] };

                const now = new Date();
                const timeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

                if (this.state.isOnBreak) {
                    this.data.daily[today].entries.push({ type: 'breakend', time: timeStr });
                    this.state.isOnBreak = false;
                }

                this.data.daily[today].entries.push({ type: 'back', time: timeStr });
                this.state.currentMode = null;

                this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));
                this.log('success', 'Session beendet');
                this.save();
                this.syncToSupabase();
                this.updateUI();
            },

            calc() {
                const todayKey = this.getLocalDateKey(new Date());
                const day = this.data.daily[todayKey];
                let totalMins = 0;

                if (day && day.entries && day.entries.length > 0) {
                    const entries = [...day.entries].sort((a, b) => a.time.localeCompare(b.time));
                    for (let i = 0; i < entries.length - 1; i++) {
                        if (entries[i].type === 'office' || entries[i].type === 'drive') {
                            for (let j = i + 1; j < entries.length; j++) {
                                if (entries[j].type === 'back') {
                                    const start = new Date(entries[i].time);
                                    const end = new Date(entries[j].time);
                                    let sessionMins = (end - start) / 60000;
                                    
                                    for (let k = i; k < j; k++) {
                                        if (entries[k].type === 'breakstart') {
                                            for (let l = k + 1; l < j; l++) {
                                                if (entries[l].type === 'breakend') {
                                                    const breakStart = new Date(entries[k].time);
                                                    const breakEnd = new Date(entries[l].time);
                                                    sessionMins -= (breakEnd - breakStart) / 60000;
                                                    k = l;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    totalMins += Math.max(0, sessionMins);
                                    i = j;
                                    break;
                                }
                            }
                        }
                    }
                }

                totalMins = Math.max(0, totalMins);
                const hours = Math.floor(totalMins / 60);
                const mins = Math.round(totalMins % 60);
                document.getElementById('statToday').innerText = `${hours}:${String(mins).padStart(2, '0')}`;

                const target = this.data.config.targetHours * 60;
                const diff = totalMins - target;
                const diffHours = Math.floor(Math.abs(diff) / 60);
                const diffMins = Math.round((Math.abs(diff) % 60));
                const diffSign = diff >= 0 ? '+' : '-';
                const diffVal = document.getElementById('statDiff');
                diffVal.innerText = `${diffSign}${diffHours}:${String(diffMins).padStart(2, '0')}`;
                diffVal.classList.remove('positive', 'negative');
                if (diff >= 0) {
                    diffVal.classList.add('positive');
                } else {
                    diffVal.classList.add('negative');
                }
            },

            updateAccountDisplay() {
                const todayKey = this.getLocalDateKey(new Date());
                const day = this.data.daily[todayKey];
                let todayMins = 0;

                if (day && day.entries && day.entries.length > 0) {
                    const entries = [...day.entries].sort((a, b) => a.time.localeCompare(b.time));
                    for (let i = 0; i < entries.length - 1; i++) {
                        if (entries[i].type === 'office' || entries[i].type === 'drive') {
                            for (let j = i + 1; j < entries.length; j++) {
                                if (entries[j].type === 'back') {
                                    const start = new Date(entries[i].time);
                                    const end = new Date(entries[j].time);
                                    todayMins += (end - start) / 60000;
                                    i = j;
                                    break;
                                }
                            }
                        }
                    }
                }

                const todayHours = Math.floor(todayMins / 60);
                const todayMs = Math.round(todayMins % 60);
                document.getElementById('accountToday').innerText = `${todayHours}:${String(todayMs).padStart(2, '0')}`;

                const allDays = Object.keys(this.data.daily).filter(k => k <= todayKey).sort();
                let workdaysCount = 0;
                allDays.forEach(day => {
                    const d = new Date(day + 'T00:00:00');
                    if (d.getDay() !== 0 && d.getDay() !== 6) {
                        workdaysCount++;
                    }
                });
                document.getElementById('workdaysCount').innerText = workdaysCount.toString();
                document.getElementById('cumulativeValue').innerText = '+0:00';
            },

            showSupabaseWizard() {
                document.getElementById('supabaseWizard').classList.add('active');
            },

            closeSupabaseWizard() {
                document.getElementById('supabaseWizard').classList.remove('active');
                document.getElementById('supabaseUrl').value = '';
                document.getElementById('supabaseKey').value = '';
            },

            saveSupabaseSettings() {
                const url = document.getElementById('supabaseUrl').value.trim();
                const key = document.getElementById('supabaseKey').value.trim();

                if (!url || !url.startsWith('https://') || !url.includes('supabase')) {
                    this.log('error', 'Ung√ºltige URL');
                    alert('‚ùå Ung√ºltige URL');
                    return;
                }
                if (!key || key.length < 50) {
                    this.log('error', 'Ung√ºltiger API Key');
                    alert('‚ùå Ung√ºltiger API Key');
                    return;
                }

                this.data.config.supabaseUrl = url;
                this.data.config.supabaseKey = key;
                this.save();
                this.setupSupabase();
                this.closeSupabaseWizard();
                this.updateSyncStatus();
                this.syncToSupabase();
                this.log('success', 'Supabase verbunden');
                alert('‚úÖ Supabase verbunden!');
            },

            updateSyncStatus() {
                const status = document.getElementById('syncStatus2');
                if (this.state.supabaseClient) {
                    status.innerHTML = '<span class="success-box" style="margin-bottom: 0;">‚úÖ Verbunden</span>';
                } else {
                    status.innerHTML = '<span class="error-box" style="margin-bottom: 0;">‚ö†Ô∏è Nicht verbunden</span>';
                }
            },

            disconnectSupabase() {
                if (confirm('Supabase trennen?')) {
                    this.data.config.supabaseUrl = null;
                    this.data.config.supabaseKey = null;
                    this.state.supabaseClient = null;
                    this.save();
                    this.updateSyncStatus();
                    this.log('info', 'Supabase getrennt');
                }
            },

            async testSupabase() {
                if (!this.state.supabaseClient) {
                    this.log('error', 'Supabase nicht verbunden');
                    alert('‚ö†Ô∏è Supabase nicht verbunden');
                    return;
                }

                this.log('info', 'Starte Supabase Test...');
                try {
                    const { data, error } = await this.state.supabaseClient
                        .from('stempel_data')
                        .select('user_id')
                        .limit(1);

                    if (error) {
                        this.log('error', `Test Fehler: ${error.message}`);
                        alert(`‚ùå Fehler: ${error.message}`);
                    } else {
                        this.log('success', 'Supabase Test erfolgreich');
                        alert('‚úÖ Supabase verbindung OK!');
                    }
                } catch (e) {
                    this.log('error', `Test Exception: ${e.message}`);
                    alert(`‚ùå Fehler: ${e.message}`);
                }
            },

            async syncToSupabase() {
                if (!this.state.supabaseClient || this.state.isSyncing) return;

                this.state.isSyncing = true;
                document.getElementById('syncStatus').innerText = '‚¨ÜÔ∏è Sync...';

                const nowIso = new Date().toISOString();

                try {
                    this.log('info', 'Upload zu Supabase...');
                    const { error } = await this.state.supabaseClient
                        .from('stempel_data')
                        .upsert(
                            {
                                user_id: GLOBAL_USER_ID,
                                data: this.data,
                                last_sync: nowIso
                            },
                            { onConflict: 'user_id' }
                        );

                    if (error) throw error;

                    this.state.lastSyncTime = nowIso;
                    document.getElementById('syncStatus').innerText = '‚úÖ OK';
                    this.log('success', 'Upload erfolgreich');
                } catch (e) {
                    document.getElementById('syncStatus').innerText = '‚ö†Ô∏è Offline';
                    this.log('error', `Upload Fehler: ${e.message}`);
                } finally {
                    this.state.isSyncing = false;
                    setTimeout(() => {
                        if (!this.state.isSyncing) document.getElementById('syncStatus').innerText = '‚òÅÔ∏è Bereit';
                    }, 2000);
                }
            },

            async syncWithSupabase() {
                if (!this.state.supabaseClient || this.state.isSyncing) return;

                try {
                    const { data, error } = await this.state.supabaseClient
                        .from('stempel_data')
                        .select('*')
                        .eq('user_id', GLOBAL_USER_ID)
                        .order('last_sync', { ascending: false })
                        .limit(1);

                    if (error || !data || data.length === 0) return;

                    const row = data[0];
                    const remoteTs = row.last_sync || '2000-01-01';
                    const localTs = this.state.lastSyncTime || '2000-01-01';

                    if (remoteTs > localTs) {
                        this.data = row.data;
                        this.save();
                        this.reconstructStateFromToday();
                        this.updateUI();
                        this.state.lastSyncTime = remoteTs;
                        this.log('success', 'Download erfolgreich');
                    }
                } catch (e) {
                    this.log('error', `Download Fehler: ${e.message}`);
                }
            },

            saveSettings() {
                this.data.config.targetHours = parseFloat(document.getElementById('cfgTarget').value) || 7.8;
                this.save();
                this.syncToSupabase();
                this.updateUI();
                this.log('success', 'Einstellungen gespeichert');
                alert('‚úÖ Gespeichert');
            },

            toggleDebugPanel() {
                this.state.debugPanelOpen = !this.state.debugPanelOpen;
                document.getElementById('debugPanel').style.display = this.state.debugPanelOpen ? 'block' : 'none';
            },

            updateDebugDisplay() {
                const logDiv = document.getElementById('debugLog');
                let html = '';
                this.state.debugLog.forEach(entry => {
                    const className = `debug-log-${entry.type}`;
                    html += `<div class="debug-log-line ${className}">${entry.msg}</div>`;
                });
                logDiv.innerHTML = html;
                logDiv.scrollTop = logDiv.scrollHeight;
            },

            clearDebugLog() {
                this.state.debugLog = [];
                document.getElementById('debugLog').innerHTML = '';
                this.log('info', 'Debug Log gel√∂scht');
            },

            exportDebugLog() {
                const content = this.state.debugLog.map(e => e.msg).join('\n');
                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `debug_${new Date().toISOString().slice(0, 16)}.txt`;
                link.click();
                this.log('success', 'Debug Log exportiert');
            },

            nav(id) {
                ['work', 'settings'].forEach(p => {
                    document.getElementById('page-' + p).classList.toggle('active', p === id);
                });
                document.querySelectorAll('.nav-item').forEach((e, i) => {
                    e.classList.toggle('active', i === ['work', 'settings'].indexOf(id));
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
