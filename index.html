<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stempel v15.1</title>
    <style>
        :root { 
            --primary: #218d8f; 
            --bg: #f2f2f7; 
            --card: #ffffff; 
            --text: #000;
            --success: #34c759;
            --danger: #ff3b30;
            --warning: #ff9500;
            --info: #007aff;
            --purple: #8b5cf6;
            --gray: #8e8e93;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding-bottom: 90px; 
            user-select: none; 
        }
        
        /* HEADER */
        .header { 
            background: var(--card); 
            padding: 15px; 
            text-align: center; 
            border-bottom: 1px solid #e0e0e0; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .time-big { 
            font-size: 36px; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; 
            color: var(--primary); 
        }
        .date-small { 
            font-size: 13px; 
            color: var(--gray); 
            margin-top: 4px; 
        }
        .sync-status { 
            font-size: 10px; 
            color: var(--gray); 
            margin-top: 5px; 
        }

        /* PAGES & CARDS */
        .page { 
            display: none; 
            padding: 15px; 
            animation: fadeIn 0.2s;
        }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h2 { 
            font-size: 17px; 
            font-weight: 600; 
            margin-bottom: 12px; 
            color: var(--primary); 
            border-bottom: 1px solid #eee; 
            padding-bottom: 8px; 
        }
        
        h3 { 
            font-size: 14px; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: #333; 
        }

        /* BUTTONS */
        button { 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover:not(:disabled) { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
        button:active:not(:disabled) { 
            opacity: 0.7; 
            transform: translateY(0); 
        }
        button:disabled { 
            opacity: 0.3; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .btn-green { background: var(--success); color: white; width: 100%; padding: 14px; margin-bottom: 10px; }
        .btn-red { background: var(--danger); color: white; width: 100%; padding: 14px; margin-bottom: 10px; }
        .btn-blue { background: var(--info); color: white; width: 100%; padding: 14px; margin-bottom: 10px; }
        .btn-purple { background: var(--purple); color: white; width: 100%; padding: 14px; margin-bottom: 10px; }
        .btn-gray { background: #e5e5ea; color: #000; width: 100%; padding: 14px; margin-bottom: 10px; }
        .btn-orange { background: var(--warning); color: white; width: 100%; padding: 14px; margin-bottom: 10px; }

        /* MODE SWITCH */
        .mode-switch { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .mode-btn { 
            padding: 12px; 
            border-radius: 10px; 
            border: 2px solid #ccc; 
            background: white; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn.active { 
            border-color: var(--primary); 
            background: var(--primary); 
            color: white; 
        }
        
        /* BUTTON ROW */
        .button-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .button-row button { margin-bottom: 0; }
        
        /* STATS */
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-box { 
            background: #f9f9fb; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center;
            border: 1px solid #e8e8e8;
        }
        .stat-lbl { 
            font-size: 11px; 
            color: var(--gray); 
            text-transform: uppercase; 
            margin-bottom: 5px;
            font-weight: 600;
        }
        .stat-val { 
            font-size: 22px; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; 
        }
        .stat-val.pos { color: var(--success); }
        .stat-val.neg { color: var(--danger); }

        /* ENTRIES */
        .entry-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9fb; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            font-size: 14px;
            border-left: 3px solid var(--primary);
        }
        .entry-row-label { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
        }
        .entry-row-label-type { 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 2px; 
        }
        .entry-row-label-time { 
            font-size: 12px; 
            color: var(--gray); 
        }
        .entry-row-actions { 
            display: flex; 
            gap: 6px; 
        }
        .entry-row-actions button { 
            width: auto; 
            padding: 6px 10px; 
            font-size: 12px; 
            margin: 0;
            box-shadow: none;
        }

        /* CALENDAR */
        .calendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            margin-top: 10px; 
        }
        .cal-header {
            text-align: center;
            font-weight: 600;
            color: var(--gray);
            font-size: 10px;
            padding: 5px;
        }
        .cal-day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f2f2f7; 
            border-radius: 6px; 
            font-size: 12px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .cal-day:hover:not(.weekend):not(.holiday) { 
            transform: scale(1.05); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .cal-day.vacation { 
            background: rgba(52, 199, 89, 0.2); 
            color: #2d8a3e; 
            border: 2px solid var(--success); 
        }
        .cal-day.sick { 
            background: rgba(255, 149, 0, 0.2); 
            color: #d97706; 
            border: 2px solid var(--warning); 
        }
        .cal-day.vacation-half { 
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.2) 50%, #f2f2f7 50%); 
            color: #2d8a3e; 
            border: 2px solid var(--success); 
        }
        .cal-day.holiday { 
            background: rgba(255, 59, 48, 0.15); 
            color: #c2185b; 
            border: 2px solid var(--danger); 
            cursor: not-allowed; 
            opacity: 0.6; 
        }
        .cal-day.weekend { 
            color: #ccc; 
            pointer-events: none; 
            background: #fff; 
        }

        .cal-mode-btn { 
            flex: 1; 
            font-size: 12px; 
            padding: 8px; 
            border: 2px solid #e5e5ea; 
            background: #fff; 
            color: #000; 
            cursor: pointer; 
            border-radius: 6px;
            transition: all 0.2s;
        }
        .cal-mode-btn.active { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }

        /* NAVIGATION */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--card); 
            border-top: 1px solid #e0e0e0; 
            display: flex; 
            padding-bottom: env(safe-area-inset-bottom); 
            height: 80px; 
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--gray); 
            font-size: 10px; 
            font-weight: 500; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover { background: rgba(0,0,0,0.02); }
        .nav-item.active { color: var(--primary); }
        .nav-icon { 
            font-size: 24px; 
            margin-bottom: 4px; 
        }

        /* MODALS */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 500; 
            align-items: center; 
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            width: 90%; 
            max-width: 500px; 
            padding: 20px; 
            border-radius: 12px; 
            max-height: 80vh; 
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ALERT BOXES */
        .info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 10px;
            border-radius: 8px;
            color: #1565c0;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .warning-box { 
            background: #fef3c7; 
            border: 1px solid #fcd34d; 
            padding: 10px; 
            border-radius: 8px; 
            color: #92400e; 
            font-size: 12px; 
            margin-bottom: 15px; 
        }
        .error-box { 
            background: #fee2e2; 
            border: 1px solid #fca5a5; 
            padding: 10px; 
            border-radius: 8px; 
            color: #991b1b; 
            font-size: 12px; 
            margin-bottom: 15px; 
        }
        .success-box { 
            background: #dcfce7; 
            border: 1px solid #86efac; 
            padding: 10px; 
            border-radius: 8px; 
            color: #166534; 
            font-size: 12px; 
            margin-bottom: 15px; 
        }

        /* SPESEN */
        .spesen-day { 
            background: #f9f9fb; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--success); 
        }
        .spesen-day-date { 
            font-weight: 700; 
            color: #333; 
            margin-bottom: 8px; 
            font-size: 14px; 
        }
        .spesen-day-time { 
            font-size: 13px; 
            color: #666; 
            margin-bottom: 4px; 
        }
        .spesen-day-hours { 
            font-size: 13px; 
            color: var(--success); 
            font-weight: 600; 
        }

        /* BADGES */
        .pause-badge { 
            display: inline-block; 
            background: var(--warning); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            margin-left: 8px; 
        }

        /* FORMS */
        .editor-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .editor-header input { 
            flex: 1; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #c6c6c8; 
            font-size: 16px; 
            margin-right: 10px; 
        }
        .editor-header button { margin: 0; }
        
        input, select { 
            width: 100%; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #c6c6c8; 
            font-size: 16px;
            font-family: inherit;
        }
        
        label { 
            font-size: 12px; 
            color: var(--gray); 
            display: block; 
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        /* WIZARD */
        .wizard-step {
            display: none;
            animation: fadeIn 0.3s;
        }
        .wizard-step.active {
            display: block;
        }
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .step-indicator {
            text-align: center;
            margin-bottom: 20px;
            color: var(--gray);
            font-size: 12px;
        }
        .step-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e5e5ea;
            transition: all 0.3s;
        }
        .step-dot.active {
            background: var(--primary);
            width: 24px;
            border-radius: 4px;
        }
        
        /* CODE DISPLAY */
        .code-box {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="time-big" id="clock">00:00:00</div>
    <div class="date-small" id="dateDisplay">-</div>
    <div class="sync-status" id="syncStatus">‚òÅÔ∏è Bereit</div>
</div>

<!-- PAGE 1: ARBEIT -->
<div id="page-work" class="page active">
    <div class="card">
        <div id="warningBox"></div>
        <div id="statusDisplay" style="text-align:center; margin-bottom:20px; font-size:18px; font-weight:700; color:var(--gray);">Bereit</div>
        
        <div id="modeSelection" style="margin-bottom:20px;">
            <p style="font-size:12px; color:var(--gray); margin-bottom:8px; text-align:center;">Was startest du?</p>
            <div class="mode-switch">
                <button class="mode-btn active" id="modeBuero" onclick="app.setStartMode('office')">üè¢ B√úRO</button>
                <button class="mode-btn" id="modeFahrt" onclick="app.setStartMode('drive')">üöó FAHRT</button>
            </div>
            <button class="btn-green" id="btnStart" onclick="app.startSession()" style="margin-bottom:0;">‚ñ∂Ô∏è STARTEN</button>
        </div>

        <div id="controls" style="display:none;">
            <div class="button-row">
                <button class="btn-blue" id="btnSwitch" onclick="app.switchMode()">üîÑ WECHSEL</button>
                <button class="btn-orange" id="btnPause" onclick="app.togglePause()">‚è∏Ô∏è PAUSE</button>
            </div>
            <button class="btn-red" id="btnFinish" onclick="app.finishSession()">‚èπÔ∏è FERTIG</button>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-lbl">Heute</div>
                <div class="stat-val" id="valToday">0:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">Konto</div>
                <div class="stat-val" id="valTotal">0:00</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üìã Verlauf Heute</h2>
        <div id="timelineList" style="font-size:13px;"></div>
    </div>
</div>

<!-- PAGE 2: BEARBEITEN -->
<div id="page-editor" class="page">
    <div class="card">
        <h2>‚úèÔ∏è Eintr√§ge bearbeiten</h2>
        <div class="editor-header">
            <input type="date" id="editorDate" onchange="app.loadEditor()">
            <button class="btn-blue" onclick="app.showAddModal()" style="margin-bottom:0; width:auto;">‚ûï NEU</button>
        </div>
        <div id="editorList" style="font-size:13px;"></div>
    </div>
</div>

<!-- PAGE 3: URLAUB -->
<div id="page-calendar" class="page">
    <div class="card">
        <h2>üìÖ Urlaub & Krankheit</h2>
        <div style="margin-bottom:15px;">
            <label>Monat</label>
            <input type="month" id="calMonth" onchange="app.renderCalendar()">
        </div>
        
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="cal-mode-btn active" id="modeVacation" onclick="app.setCalMode('vacation')">üèñÔ∏è Urlaub</button>
            <button class="cal-mode-btn" id="modeHalf" onclick="app.setCalMode('half')">‚è∞ ¬Ω Urlaub</button>
            <button class="cal-mode-btn" id="modeSick" onclick="app.setCalMode('sick')">ü§í Krank</button>
        </div>

        <div id="calendarGrid" class="calendar"></div>
    </div>
</div>

<!-- PAGE 4: SPESEN -->
<div id="page-spesen" class="page">
    <div class="card">
        <h2>üöó Fahrtspesen (‚â•8h)</h2>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">Alle Fahrten mit mindestens 8 Stunden an einem Tag. Fahrten werden automatisch berechnet ‚Äì auch bei manuellen Eintr√§gen.</p>
        
        <div style="margin-bottom:15px;">
            <label>Zeitraum</label>
            <input type="month" id="spesenMonth" onchange="app.renderSpesenByMonth()">
        </div>

        <div id="spesenList" style="font-size:13px;"></div>

        <button class="btn-gray" onclick="app.exportSpesen()" style="margin-top:15px;">üìä CSV exportieren</button>
    </div>
</div>

<!-- PAGE 5: SETTINGS -->
<div id="page-settings" class="page">
    <div class="card">
        <h2>‚òÅÔ∏è Dropbox Sync</h2>
        <div id="dropboxStatus" style="margin-bottom:15px;"></div>
        <div style="font-size:11px; color:#666; margin-bottom:10px;" id="lastSyncInfo"></div>
        
        <button class="btn-green" onclick="app.showDropboxWizard()" id="btnDropboxSetup">
            <span id="dropboxSetupText">üîß Dropbox einrichten</span>
        </button>
        <button class="btn-gray" onclick="app.logoutDropbox()" style="margin-bottom:20px;">Trennen</button>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Arbeitszeit</h2>
        <div style="margin-bottom:15px;">
            <label>Sollstunden/Tag</label>
            <input type="number" id="cfgTarget" value="7.8" step="0.1" min="0" max="24">
        </div>
        <div style="margin-bottom:15px;">
            <label>Start-Saldo (h)</label>
            <input type="number" id="cfgBalance" value="0" step="0.1">
        </div>
        <button class="btn-green" onclick="app.saveSettings()">üíæ Einstellungen Speichern</button>
        <button class="btn-red" style="margin-top:20px;" onclick="app.showResetModal()">üóëÔ∏è Alles l√∂schen</button>
    </div>
</div>

<!-- NAV -->
<div class="nav">
    <div class="nav-item active" onclick="app.nav('work')" id="nav-work"><span class="nav-icon">‚è±Ô∏è</span>Arbeit</div>
    <div class="nav-item" onclick="app.nav('editor')" id="nav-editor"><span class="nav-icon">‚úèÔ∏è</span>Bearbeiten</div>
    <div class="nav-item" onclick="app.nav('calendar')" id="nav-calendar"><span class="nav-icon">üìÖ</span>Urlaub</div>
    <div class="nav-item" onclick="app.nav('spesen')" id="nav-spesen"><span class="nav-icon">üöó</span>Spesen</div>
    <div class="nav-item" onclick="app.nav('settings')" id="nav-settings"><span class="nav-icon">‚öôÔ∏è</span>Setup</div>
</div>

<!-- MODAL: DROPBOX WIZARD -->
<div id="dropboxWizard" class="modal">
    <div class="modal-content">
        <h3>üîß Dropbox einrichten</h3>
        
        <div class="step-indicator">
            <div id="wizardStepText">Schritt 1 von 3</div>
            <div class="step-dots">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
            </div>
        </div>
        
        <!-- STEP 1: App erstellen -->
        <div class="wizard-step active" id="wizard-step-1">
            <div class="info-box">
                <strong>üì± Dropbox App erstellen</strong><br>
                Um die Synchronisation zu nutzen, ben√∂tigen wir eine Dropbox App.
            </div>
            
            <ol style="font-size:13px; line-height:1.8; margin:15px 0; padding-left:20px;">
                <li>√ñffne <a href="https://www.dropbox.com/developers/apps/create" target="_blank" style="color:var(--info);">Dropbox App Console</a></li>
                <li>W√§hle: <strong>"Scoped access"</strong></li>
                <li>W√§hle: <strong>"Full Dropbox"</strong></li>
                <li>App-Name: <code style="background:#f0f0f0; padding:2px 6px; border-radius:4px;">Stempel-App</code></li>
                <li>Klicke auf <strong>"Create app"</strong></li>
            </ol>
            
            <div class="wizard-nav">
                <button class="btn-gray" onclick="app.closeDropboxWizard()">Abbrechen</button>
                <button class="btn-blue" onclick="app.wizardNext()">Weiter ‚Üí</button>
            </div>
        </div>
        
        <!-- STEP 2: Berechtigungen -->
        <div class="wizard-step" id="wizard-step-2">
            <div class="info-box">
                <strong>üîê Berechtigungen einrichten</strong><br>
                Wir ben√∂tigen Zugriff auf die Dropbox-Dateien.
            </div>
            
            <ol style="font-size:13px; line-height:1.8; margin:15px 0; padding-left:20px;">
                <li>Gehe zum Tab <strong>"Permissions"</strong></li>
                <li>Aktiviere unter "Files and folders":<br>
                    <div style="margin:10px 0; padding:10px; background:#f9f9f9; border-radius:6px;">
                        ‚úÖ <code>files.content.write</code><br>
                        ‚úÖ <code>files.content.read</code>
                    </div>
                </li>
                <li>Klicke unten auf <strong>"Submit"</strong></li>
            </ol>
            
            <div class="wizard-nav">
                <button class="btn-gray" onclick="app.wizardPrev()">‚Üê Zur√ºck</button>
                <button class="btn-blue" onclick="app.wizardNext()">Weiter ‚Üí</button>
            </div>
        </div>
        
        <!-- STEP 3: App Key -->
        <div class="wizard-step" id="wizard-step-3">
            <div class="info-box">
                <strong>üîë App Key kopieren</strong><br>
                Fast geschafft! Kopiere jetzt den App Key.
            </div>
            
            <ol style="font-size:13px; line-height:1.8; margin:15px 0; padding-left:20px;">
                <li>Gehe zum Tab <strong>"Settings"</strong></li>
                <li>Finde den <strong>"App key"</strong></li>
                <li>Kopiere den Key und f√ºge ihn unten ein</li>
            </ol>
            
            <div style="margin:15px 0;">
                <label>Dropbox App Key</label>
                <input type="text" id="wizardClientId" placeholder="z.B. abcdefgh12345678">
            </div>
            
            <div class="success-box" style="display:none;" id="wizardSuccess">
                ‚úÖ App Key gespeichert! Du wirst jetzt zu Dropbox weitergeleitet.
            </div>
            
            <div class="wizard-nav">
                <button class="btn-gray" onclick="app.wizardPrev()">‚Üê Zur√ºck</button>
                <button class="btn-green" onclick="app.wizardComplete()">‚úÖ Verbinden</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: ADD/EDIT ENTRY -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Eintrag hinzuf√ºgen</h3>
        <br>
        <label>Typ</label>
        <select id="addType" style="margin-bottom:10px;">
            <option value="office">üè¢ B√ºro Start</option>
            <option value="drive">üöó Fahrt Start</option>
            <option value="break_start">‚è∏Ô∏è Pause Start</option>
            <option value="break_end">‚ñ∂Ô∏è Pause Ende</option>
            <option value="back">‚èπÔ∏è Session Beenden</option>
        </select>
        <label style="margin-top:10px;">Zeit</label>
        <input type="time" id="addTime" style="margin-bottom:15px;">
        <button class="btn-green" onclick="app.saveModalEntry()">‚úÖ Speichern</button>
        <button class="btn-gray" onclick="app.closeAddModal()">Abbrechen</button>
    </div>
</div>

<!-- MODAL: RESET CONFIRMATION -->
<div id="resetModal" class="modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Alles l√∂schen?</h3>
        <p style="font-size:13px; color:#666; margin:15px 0;">Diese Aktion l√∂scht <b>ALLE</b> Daten lokal und kann nicht r√ºckg√§ngig gemacht werden. Stell sicher, dass deine Daten auf Dropbox gespeichert sind!</p>
        <label>Gib "RESET" ein zur Best√§tigung:</label>
        <input type="text" id="resetConfirmInput" placeholder="RESET" style="margin-bottom:15px;">
        <button class="btn-red" onclick="app.confirmReset()">Best√§tigen</button>
        <button class="btn-gray" onclick="app.closeResetModal()">Abbrechen</button>
    </div>
</div>

<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script>
const APP_VERSION = 15;
const STORAGE_KEY = 'stempel_v15';

const app = {
    data: {
        version: APP_VERSION,
        daily: {},
        spesen: [],
        config: { target: 7.8, balance: 0, clientId: '' },
        lastSyncTime: null
    },
    
    state: { 
        status: 'off',
        currentMode: null,
        isOnBreak: false,
        calMode: 'vacation',
        dropboxToken: null,
        isSyncing: false,
        actionLocked: false,
        syncQueue: [],
        startMode: 'office',
        editingDateEntry: null,
        editingIndex: null,
        wizardStep: 1
    },

    hessenHolidays: [
        '2025-01-01', '2025-04-18', '2025-04-21', '2025-05-01', '2025-05-29', '2025-06-09', '2025-06-19', '2025-10-03', '2025-12-25', '2025-12-26',
        '2026-01-01', '2026-04-03', '2026-04-06', '2026-05-01', '2026-05-14', '2026-05-25', '2026-06-04', '2026-10-03', '2026-12-25', '2026-12-26',
        '2027-01-01', '2027-03-26', '2027-03-29', '2027-05-01', '2027-05-06', '2027-05-17', '2027-05-27', '2027-10-03', '2027-12-25', '2027-12-26',
        '2028-01-01', '2028-04-14', '2028-04-17', '2028-05-01', '2028-05-25', '2028-06-05', '2028-06-15', '2028-10-03', '2028-12-25', '2028-12-26',
        '2029-01-01', '2029-03-30', '2029-04-02', '2029-05-01', '2029-05-10', '2029-05-21', '2029-05-31', '2029-10-03', '2029-12-25', '2029-12-26',
        '2030-01-01', '2030-04-19', '2030-04-22', '2030-05-01', '2030-05-30', '2030-06-10', '2030-06-20', '2030-10-03', '2030-12-25', '2030-12-26'
    ],

    // HILFSFUNKTIONEN
    getLocalDateKey(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const date = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${date}`;
    },

    formatTime(hours) {
        const h = Math.floor(Math.abs(hours));
        const m = Math.round((Math.abs(hours) - h) * 60);
        return (hours < 0 ? "-" : "") + h + ":" + (m < 10 ? "0" : "") + m;
    },

    isHoliday(dateStr) {
        return this.hessenHolidays.includes(dateStr);
    },

    isWeekend(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        return (d.getDay() === 0 || d.getDay() === 6);
    },

    validateTime(timeStr) {
        const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return regex.test(timeStr);
    },

    // INITIALISIERUNG
    init() {
        console.log('üöÄ Stempel v15.1 initialisiert');
        
        // Daten laden
        const s = localStorage.getItem(STORAGE_KEY);
        if (s) {
            try { 
                const parsed = JSON.parse(s);
                if (parsed && parsed.daily && parsed.config) {
                    this.data = parsed;
                    this.migrateDataIfNeeded();
                }
            } catch (e) { 
                console.error("‚ùå Fehler beim Laden:", e); 
                alert("‚ö†Ô∏è Warnung: Daten konnten nicht geladen werden! Bitte Support kontaktieren.");
            }
        }

        // Dropbox Token laden
        const token = localStorage.getItem('dropbox_token');
        if (token) this.state.dropboxToken = token;

        // UI initialisieren
        const today = new Date();
        document.getElementById('editorDate').valueAsDate = today;
        document.getElementById('calMonth').value = today.toISOString().slice(0, 7);
        document.getElementById('spesenMonth').value = today.toISOString().slice(0, 7);
        document.getElementById('cfgTarget').value = this.data.config.target;
        document.getElementById('cfgBalance').value = this.data.config.balance;

        // Timer starten
        setInterval(() => this.tick(), 1000);
        this.tick();

        // Initiale Berechnungen
        this.calc();
        this.renderCalendar();
        this.renderSpesenByMonth();
        this.updateDropboxStatus();
        
        // Dropbox Daten laden (falls verbunden)
        if (this.state.dropboxToken) {
            setTimeout(() => this.loadFromDropbox(), 1000);
        }
    },

    migrateDataIfNeeded() {
        if (!this.data.version || this.data.version < APP_VERSION) {
            console.log(`üì¶ Migration v${this.data.version || 0} ‚Üí v${APP_VERSION}`);
            this.data.version = APP_VERSION;
            
            // Datenintegrit√§t pr√ºfen
            Object.keys(this.data.daily).forEach(key => {
                if (!this.data.daily[key].entries) {
                    this.data.daily[key].entries = [];
                }
            });
            
            this.save();
        }
    },

    save() {
        try {
            const dataStr = JSON.stringify(this.data);
            if (dataStr.length > 5000000) { // 5MB Limit
                console.warn('‚ö†Ô∏è Daten zu gro√ü (>5MB)');
                alert('‚ö†Ô∏è Warnung: Datenbank wird sehr gro√ü. Bitte alte Eintr√§ge archivieren.');
            }
            localStorage.setItem(STORAGE_KEY, dataStr);
        } catch (e) {
            console.error("‚ùå Speicherfehler:", e);
            if (e.name === 'QuotaExceededError') {
                alert("‚ùå Speicher voll! Bitte alte Eintr√§ge l√∂schen oder Browser-Cache leeren.");
            } else {
                alert("‚ö†Ô∏è Speichern fehlgeschlagen: " + e.message);
            }
        }
    },

    // DROPBOX WIZARD
    showDropboxWizard() {
        if (this.state.dropboxToken) {
            // Bereits verbunden - OAuth neu starten
            if (confirm('Bereits verbunden. Erneut verbinden?')) {
                this.loginDropbox();
            }
            return;
        }
        
        // Wizard zur√ºcksetzen
        this.state.wizardStep = 1;
        this.updateWizardStep();
        document.getElementById('dropboxWizard').classList.add('active');
    },

    closeDropboxWizard() {
        document.getElementById('dropboxWizard').classList.remove('active');
        document.getElementById('wizardSuccess').style.display = 'none';
        document.getElementById('wizardClientId').value = '';
    },

    updateWizardStep() {
        const step = this.state.wizardStep;
        
        // Steps ein/ausblenden
        for (let i = 1; i <= 3; i++) {
            const stepEl = document.getElementById(`wizard-step-${i}`);
            const dotEl = document.getElementById(`dot${i}`);
            
            if (i === step) {
                stepEl.classList.add('active');
                dotEl.classList.add('active');
            } else {
                stepEl.classList.remove('active');
                dotEl.classList.remove('active');
            }
        }
        
        // Text aktualisieren
        document.getElementById('wizardStepText').innerText = `Schritt ${step} von 3`;
    },

    wizardNext() {
        if (this.state.wizardStep < 3) {
            this.state.wizardStep++;
            this.updateWizardStep();
        }
    },

    wizardPrev() {
        if (this.state.wizardStep > 1) {
            this.state.wizardStep--;
            this.updateWizardStep();
        }
    },

    async wizardComplete() {
        const clientId = document.getElementById('wizardClientId').value.trim();
        
        if (!clientId) {
            alert('‚ùå Bitte App Key eingeben!');
            return;
        }
        
        // Validierung (grobe Pr√ºfung)
        if (clientId.length < 10) {
            alert('‚ùå App Key scheint ung√ºltig zu sein (zu kurz)');
            return;
        }
        
        // Speichern
        this.data.config.clientId = clientId;
        this.save();
        
        // Success anzeigen
        document.getElementById('wizardSuccess').style.display = 'block';
        console.log('‚úÖ Client ID gespeichert');
        
        // Nach 2 Sekunden zu Dropbox weiterleiten
        setTimeout(() => {
            this.closeDropboxWizard();
            this.loginDropbox();
        }, 2000);
    },

    // MODUS-VERWALTUNG
    setStartMode(mode) {
        this.state.startMode = mode;
        document.getElementById('modeBuero').classList.toggle('active', mode === 'office');
        document.getElementById('modeFahrt').classList.toggle('active', mode === 'drive');
    },

    // SESSION-VERWALTUNG
    startSession() {
        if (this.state.actionLocked) {
            console.log('‚è≥ Action locked');
            return;
        }
        
        this.state.actionLocked = true;
        setTimeout(() => { this.state.actionLocked = false; }, 1000);

        const today = this.getLocalDateKey(new Date());
        if (!this.data.daily[today]) {
            this.data.daily[today] = { entries: [] };
        }

        const now = new Date();
        const localTimeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        
        this.data.daily[today].entries.push({ 
            type: this.state.startMode, 
            time: localTimeStr
        });

        this.state.currentMode = this.state.startMode;
        this.state.isOnBreak = false;

        this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));
        
        console.log(`‚úÖ Session gestartet: ${this.state.startMode} um ${localTimeStr.split('T')[1]}`);
        
        this.save();
        this.syncToDropbox();
        this.calc();
    },

    switchMode() {
        if (this.state.actionLocked) return;
        
        const newModeName = this.state.currentMode === 'office' ? 'Fahrt' : 'B√ºro';
        if (!confirm(`Zu ${newModeName} wechseln? Dies beendet die aktuelle Aktivit√§t.`)) {
            return;
        }
        
        this.state.actionLocked = true;
        setTimeout(() => { this.state.actionLocked = false; }, 1000);

        const today = this.getLocalDateKey(new Date());
        const now = new Date();
        const localTimeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

        // Aktuelle Session beenden
        if (this.state.currentMode === 'drive') {
            this.calculateAndSaveSpesen(today);
        }

        this.data.daily[today].entries.push({ type: 'back', time: localTimeStr });

        // Neue Session starten
        const newMode = this.state.currentMode === 'office' ? 'drive' : 'office';
        this.data.daily[today].entries.push({ type: newMode, time: localTimeStr });
        
        this.state.currentMode = newMode;
        this.state.isOnBreak = false;

        this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));
        
        console.log(`üîÑ Gewechselt zu: ${newMode}`);
        
        this.save();
        this.syncToDropbox();
        this.calc();
        this.renderSpesenByMonth();
    },

    togglePause() {
        if (this.state.actionLocked) return;
        
        if (!this.state.currentMode) {
            alert('‚ö†Ô∏è Keine aktive Session!');
            return;
        }
        
        this.state.actionLocked = true;
        setTimeout(() => { this.state.actionLocked = false; }, 1000);

        const today = this.getLocalDateKey(new Date());
        const now = new Date();
        const localTimeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

        if (!this.state.isOnBreak) {
            this.data.daily[today].entries.push({ type: 'break_start', time: localTimeStr });
            this.state.isOnBreak = true;
            console.log('‚è∏Ô∏è Pause gestartet');
        } else {
            this.data.daily[today].entries.push({ type: 'break_end', time: localTimeStr });
            this.state.isOnBreak = false;
            console.log('‚ñ∂Ô∏è Pause beendet');
        }

        this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));
        this.save();
        this.syncToDropbox();
        this.calc();
    },

    finishSession() {
        if (this.state.actionLocked) return;

        if (!confirm('Session wirklich beenden? Alle Daten werden gespeichert.')) {
            return;
        }

        this.state.actionLocked = true;
        setTimeout(() => { this.state.actionLocked = false; }, 1000);

        const today = this.getLocalDateKey(new Date());
        const now = new Date();
        const localTimeStr = `${today}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

        // Spesen berechnen falls Fahrt
        if (this.state.currentMode === 'drive') {
            this.calculateAndSaveSpesen(today);
        }

        this.data.daily[today].entries.push({ type: 'back', time: localTimeStr });

        this.state.currentMode = null;
        this.state.isOnBreak = false;

        this.data.daily[today].entries.sort((a, b) => a.time.localeCompare(b.time));
        
        console.log('‚èπÔ∏è Session beendet');
        
        this.save();
        this.syncToDropbox();
        this.calc();
        this.renderSpesenByMonth();
    },

    // SPESEN-BERECHNUNG (Verbessert & Bug-frei)
    calculateAndSaveSpesen(dateKey) {
        if (!this.data.daily[dateKey]) return;

        const entries = this.data.daily[dateKey].entries;
        const todaySpesenToAdd = [];

        let i = 0;
        while (i < entries.length) {
            if (entries[i].type === 'drive') {
                const driveStartTime = new Date(entries[i].time);
                let driveEndTime = null;
                let totalPauseMs = 0;
                let breakStart = null;

                i++;
                
                // Durchlaufe alle Eintr√§ge bis zum Ende dieser Fahrt
                while (i < entries.length) {
                    const currentEntry = entries[i];
                    
                    if (currentEntry.type === 'back') {
                        driveEndTime = new Date(currentEntry.time);
                        i++;
                        break;
                    } else if (currentEntry.type === 'break_start') {
                        breakStart = new Date(currentEntry.time);
                    } else if (currentEntry.type === 'break_end' && breakStart) {
                        const breakEnd = new Date(currentEntry.time);
                        totalPauseMs += (breakEnd.getTime() - breakStart.getTime());
                        breakStart = null;
                    }
                    
                    i++;
                }

                // Falls kein explizites Ende: Session l√§uft noch oder Fehler
                if (!driveEndTime) {
                    console.log(`‚ö†Ô∏è Fahrt ohne Ende: ${dateKey}`);
                    break;
                }

                // Berechne Fahrtdauer
                const totalMs = driveEndTime.getTime() - driveStartTime.getTime();
                const driveMs = Math.max(0, totalMs - totalPauseMs);
                const driveHours = driveMs / 1000 / 3600;

                // Nur Fahrten >= 8h speichern
                if (driveHours >= 8) {
                    const startStr = driveStartTime.toTimeString().slice(0, 5);
                    const endStr = driveEndTime.toTimeString().slice(0, 5);

                    todaySpesenToAdd.push({
                        date: dateKey,
                        start: startStr,
                        end: endStr,
                        hours: driveHours.toFixed(2)
                    });
                    
                    console.log(`üí∞ Spesen: ${dateKey} ${startStr}-${endStr} (${driveHours.toFixed(2)}h)`);
                }
            } else {
                i++;
            }
        }

        // Alte Spesen f√ºr diesen Tag l√∂schen und neue hinzuf√ºgen
        this.data.spesen = this.data.spesen.filter(s => s.date !== dateKey);
        this.data.spesen.push(...todaySpesenToAdd);
    },

    // DROPBOX INTEGRATION
    async loginDropbox() {
        if (!this.data.config.clientId) {
            alert('‚ö†Ô∏è Bitte erst Dropbox einrichten (Setup ‚Üí Dropbox einrichten)');
            this.showDropboxWizard();
            return;
        }

        try {
            const dbx = new Dropbox.Dropbox({ clientId: this.data.config.clientId });
            const redirectUri = window.location.origin + window.location.pathname;
            const authUrl = await dbx.auth.getAuthenticationUrl(
                redirectUri,
                undefined,
                'code',
                'offline',
                undefined,
                undefined,
                true
            );
            console.log('üîê Weiterleitung zu Dropbox...');
            window.location.href = authUrl;
        } catch (e) {
            console.error('‚ùå Dropbox Auth Fehler:', e);
            alert('‚ùå Fehler bei Dropbox-Verbindung: ' + e.message + '\nBitte Client ID pr√ºfen.');
        }
    },

    async handleOAuthCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        
        if (code) {
            console.log('üîÑ OAuth Callback verarbeiten...');
            
            try {
                const codeVerifier = localStorage.getItem('dropbox_code_verifier');
                const redirectUri = window.location.origin + window.location.pathname;
                
                const dbx = new Dropbox.Dropbox({ clientId: this.data.config.clientId });
                const tokenResponse = await dbx.auth.getAccessTokenFromCode(redirectUri, code);
                
                const accessToken = tokenResponse.result.access_token;
                
                if (accessToken) {
                    this.state.dropboxToken = accessToken;
                    localStorage.setItem('dropbox_token', accessToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    this.updateDropboxStatus();
                    alert('‚úÖ Mit Dropbox verbunden!');
                    await this.syncToDropbox();
                } else {
                    throw new Error('Kein Access Token erhalten');
                }
            } catch (e) {
                console.error('‚ùå OAuth Fehler:', e);
                alert('‚ùå Fehler bei Dropbox-Authentifizierung: ' + e.message);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    },

    logoutDropbox() {
        if (!this.state.dropboxToken) {
            alert('‚ö†Ô∏è Nicht verbunden');
            return;
        }
        
        if (confirm('‚ö†Ô∏è Nach dem Trennen werden zuk√ºnftige √Ñnderungen NICHT mehr gesynct!\n\nWirklich trennen?')) {
            this.state.dropboxToken = null;
            localStorage.removeItem('dropbox_token');
            this.updateDropboxStatus();
            alert('‚úÖ Dropbox getrennt. Lokal gespeicherte Daten bleiben erhalten.');
        }
    },

    updateDropboxStatus() {
        const status = document.getElementById('dropboxStatus');
        const btn = document.getElementById('btnDropboxSetup');
        const btnText = document.getElementById('dropboxSetupText');
        
        if (this.state.dropboxToken) {
            status.innerHTML = '<div class="success-box">‚úÖ Mit Dropbox verbunden</div>';
            btnText.innerHTML = 'üîÑ Neu verbinden';
            btn.className = 'btn-blue';
        } else {
            status.innerHTML = '<div class="warning-box">‚ö†Ô∏è Nicht verbunden ‚Äì Daten werden nur lokal gespeichert</div>';
            btnText.innerHTML = 'üîß Dropbox einrichten';
            btn.className = 'btn-green';
        }
        this.updateLastSyncInfo();
    },

    updateLastSyncInfo() {
        const info = document.getElementById('lastSyncInfo');
        if (!this.data.lastSyncTime) {
            info.innerText = '';
            return;
        }
        
        const lastSync = new Date(this.data.lastSyncTime);
        const now = new Date();
        const diffMin = Math.max(0, Math.floor((now - lastSync) / 1000 / 60));
        
        let timeStr = '';
        if (diffMin < 1) timeStr = 'eben';
        else if (diffMin < 60) timeStr = `vor ${diffMin}m`;
        else if (diffMin < 1440) timeStr = `vor ${Math.floor(diffMin / 60)}h`;
        else timeStr = `vor ${Math.floor(diffMin / 1440)}d`;
        
        info.innerText = `Letzter Sync: ${timeStr}`;
    },

    async loadFromDropbox() {
        if (!this.state.dropboxToken) return;
        
        try {
            this.updateSyncStatus('‚¨áÔ∏è Laden...');
            const dbx = new Dropbox.Dropbox({ accessToken: this.state.dropboxToken });
            
            const result = await dbx.filesDownload({ path: '/Stempel/stempel_data.json' });
            const text = await result.result.fileBlob.text();
            const remoteData = JSON.parse(text);
            
            if (remoteData && remoteData.daily && typeof remoteData.daily === 'object' && 
               remoteData.config && typeof remoteData.config === 'object') {
                
                // Merge: Remote-Daten √ºberschreiben lokale (Server gewinnt)
                this.data = remoteData;
                this.data.lastSyncTime = new Date().toISOString();
                this.save();
                this.calc();
                this.renderSpesenByMonth();
                
                console.log('‚úÖ Daten von Dropbox geladen');
            }
            
            this.updateSyncStatus('‚úÖ OK');
            this.updateLastSyncInfo();
            setTimeout(() => this.updateSyncStatus('‚òÅÔ∏è Bereit'), 2000);
        } catch (e) {
            if (e.status === 409) {
                console.log('‚ÑπÔ∏è Keine Dropbox-Datei gefunden (erste Nutzung)');
                await this.syncToDropbox(); // Initiales Upload
            } else {
                console.log('‚ö†Ô∏è Dropbox Load:', e.message);
            }
            this.updateSyncStatus('‚òÅÔ∏è Bereit');
        }
    },

    async syncToDropbox() {
        if (!this.state.dropboxToken) {
            this.state.syncQueue.push(true);
            return;
        }
        
        if (this.state.isSyncing) {
            this.state.syncQueue.push(true);
            return;
        }
        
        this.state.isSyncing = true;
        this.updateSyncStatus('‚¨ÜÔ∏è Speichern...');
        
        let retries = 3;
        while (retries > 0) {
            try {
                const dbx = new Dropbox.Dropbox({ accessToken: this.state.dropboxToken });
                const jsonData = JSON.stringify(this.data, null, 2);
                
                await dbx.filesUpload({
                    path: '/Stempel/stempel_data.json',
                    contents: jsonData,
                    mode: { '.tag': 'overwrite' },
                    autorename: false
                });
                
                this.data.lastSyncTime = new Date().toISOString();
                this.save();
                this.updateSyncStatus('‚úÖ OK');
                this.updateLastSyncInfo();
                
                console.log('‚úÖ Daten zu Dropbox gesynct');
                
                setTimeout(() => this.updateSyncStatus('‚òÅÔ∏è Bereit'), 2000);
                this.state.isSyncing = false;
                
                // Queue abarbeiten
                if (this.state.syncQueue.length > 0) {
                    this.state.syncQueue = [];
                    setTimeout(() => this.syncToDropbox(), 2000);
                }
                return;
            } catch (e) {
                retries--;
                console.error(`‚ùå Sync Fehler (${3 - retries}/3):`, e);
                
                if (retries === 0) {
                    this.updateSyncStatus('‚ö†Ô∏è Offline');
                    setTimeout(() => this.updateSyncStatus('‚òÅÔ∏è Bereit'), 3000);
                } else {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        this.state.isSyncing = false;
    },

    updateSyncStatus(text) {
        const el = document.getElementById('syncStatus');
        if (el) el.innerText = text;
    },

    // WARNUNGEN
    checkWarnings() {
        const todayKey = this.getLocalDateKey(new Date());
        const today = this.data.daily[todayKey];
        let warningHTML = '';
        
        if (!today || !today.entries.length) {
            document.getElementById('warningBox').innerHTML = '';
            return;
        }

        const lastEntry = today.entries[today.entries.length - 1];
        
        // Warnung bei zu langer Session
        if (this.state.currentMode && this.state.currentMode !== null) {
            const lastTime = new Date(lastEntry.time);
            const now = new Date();
            const hoursSince = (now - lastTime) / 1000 / 3600;

            if (hoursSince > 14) {
                warningHTML += `<div class="error-box">‚ö†Ô∏è Session l√§uft seit ${Math.floor(hoursSince)}h! Bitte beenden.</div>`;
            } else if (hoursSince > 10) {
                warningHTML += `<div class="warning-box">‚è∞ Session l√§uft seit ${Math.floor(hoursSince)}h</div>`;
            }
        }

        // Warnung bei zu langer Pause
        if (this.state.isOnBreak && lastEntry.type === 'break_start') {
            const lastTime = new Date(lastEntry.time);
            const now = new Date();
            const hoursBreak = (now - lastTime) / 1000 / 3600;

            if (hoursBreak > 2) {
                warningHTML += `<div class="error-box">‚ö†Ô∏è Pause seit ${Math.floor(hoursBreak)}h! Bitte beenden.</div>`;
            } else if (hoursBreak > 1) {
                warningHTML += `<div class="warning-box">‚è∞ Pause seit ${Math.floor(hoursBreak)}h</div>`;
            }
        }

        document.getElementById('warningBox').innerHTML = warningHTML;
    },

    // NAVIGATION
    nav(id) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-' + id).classList.add('active');
        
        if (id === 'editor') this.loadEditor();
        if (id === 'calendar') this.renderCalendar();
        if (id === 'spesen') this.renderSpesenByMonth();
    },

    // TIMER
    tick() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('de-DE');
        document.getElementById('dateDisplay').innerText = now.toLocaleDateString('de-DE', {
            weekday: 'long', 
            day: 'numeric', 
            month: 'short'
        });
        
        if (this.state.currentMode) {
            this.calc();
        }

        this.checkWarnings();
        this.updateLastSyncInfo();
    },

    // MODALS
    showAddModal(editDate = null, editIdx = null) {
        document.getElementById('modalTitle').innerText = editIdx !== null ? 'Eintrag bearbeiten' : 'Eintrag hinzuf√ºgen';
        
        if (editIdx !== null && editDate) {
            const entry = this.data.daily[editDate].entries[editIdx];
            document.getElementById('addType').value = entry.type;
            document.getElementById('addTime').value = entry.time.split('T')[1].slice(0, 5);
            this.state.editingDateEntry = editDate;
            this.state.editingIndex = editIdx;
        } else {
            document.getElementById('addType').value = 'office';
            document.getElementById('addTime').value = new Date().toTimeString().slice(0, 5);
            this.state.editingDateEntry = null;
            this.state.editingIndex = null;
        }
        
        document.getElementById('addModal').classList.add('active');
    },

    saveModalEntry() {
        const d = this.state.editingDateEntry || document.getElementById('editorDate').value;
        const t = document.getElementById('addTime').value;
        const type = document.getElementById('addType').value;
        
        if (!t) { 
            alert("‚ö†Ô∏è Bitte Zeit eingeben"); 
            return; 
        }
        
        if (!this.validateTime(t)) {
            alert("‚ùå Ung√ºltige Zeit! Format: HH:MM");
            return;
        }
        
        if (!this.data.daily[d]) {
            this.data.daily[d] = { entries: [] };
        }

        if (this.state.editingIndex !== null) {
            this.data.daily[d].entries[this.state.editingIndex] = { 
                type: type, 
                time: `${d}T${t}:00`
            };
            console.log(`‚úèÔ∏è Bearbeitet: ${d} ${t} (${type})`);
        } else {
            this.data.daily[d].entries.push({ 
                type: type, 
                time: `${d}T${t}:00`
            });
            console.log(`‚ûï Neu: ${d} ${t} (${type})`);
        }
        
        this.data.daily[d].entries.sort((a, b) => a.time.localeCompare(b.time));
        
        // Spesen neu berechnen
        this.calculateAndSaveSpesen(d);
        
        this.save();
        this.syncToDropbox();
        this.closeAddModal();
        this.loadEditor();
        this.calc();
        this.renderSpesenByMonth();
    },

    closeAddModal() { 
        document.getElementById('addModal').classList.remove('active');
        document.getElementById('addTime').value = '';
        this.state.editingDateEntry = null;
        this.state.editingIndex = null;
    },

    showResetModal() { 
        document.getElementById('resetModal').classList.add('active'); 
    },
    
    closeResetModal() {
        document.getElementById('resetModal').classList.remove('active');
        document.getElementById('resetConfirmInput').value = '';
    },

    confirmReset() {
        const input = document.getElementById('resetConfirmInput').value;
        if (input !== 'RESET') {
            alert('‚ùå Eingabe falsch! Bitte "RESET" eingeben.');
            return;
        }
        
        console.log('üóëÔ∏è Alle Daten werden gel√∂scht');
        document.getElementById('resetModal').classList.remove('active');
        localStorage.clear();
        location.reload();
    },

    // EDITOR
    loadEditor() {
        const d = document.getElementById('editorDate').value;
        const list = document.getElementById('editorList');
        list.innerHTML = "";
        
        if (!this.data.daily[d] || !this.data.daily[d].entries.length) {
            list.innerHTML = "<p style='color:#ccc; text-align:center; padding:20px;'>Keine Eintr√§ge an diesem Tag</p>";
            return;
        }

        this.data.daily[d].entries.forEach((e, idx) => {
            const t = e.time.split('T')[1].slice(0, 5);
            const typeMap = {
                office: 'üè¢ B√ºro Start', 
                drive: 'üöó Fahrt Start', 
                back: '‚èπÔ∏è Session Beenden', 
                break_start: '‚è∏Ô∏è Pause Start', 
                break_end: '‚ñ∂Ô∏è Pause Ende'
            };
            let lbl = typeMap[e.type] || e.type;
            
            list.innerHTML += `<div class="entry-row">
                <div class="entry-row-label">
                    <div class="entry-row-label-type">${lbl}</div>
                    <div class="entry-row-label-time">${t} Uhr</div>
                </div>
                <div class="entry-row-actions">
                    <button class="btn-blue" onclick="app.showAddModal('${d}', ${idx})">‚úèÔ∏è</button>
                    <button class="btn-red" onclick="app.deleteEntry('${d}', ${idx})">üóëÔ∏è</button>
                </div>
            </div>`;
        });
    },

    deleteEntry(date, idx) {
        if (!confirm("‚ùå Eintrag wirklich l√∂schen?")) return;
        
        this.data.daily[date].entries.splice(idx, 1);
        
        // Spesen f√ºr diesen Tag neu berechnen
        this.calculateAndSaveSpesen(date);
        
        console.log(`üóëÔ∏è Gel√∂scht: ${date} Index ${idx}`);
        
        this.save();
        this.syncToDropbox();
        this.loadEditor();
        this.calc();
        this.renderSpesenByMonth();
    },

    // KALENDER
    setCalMode(m) {
        this.state.calMode = m;
        document.querySelectorAll('.cal-mode-btn').forEach(b => b.classList.remove('active'));
        if (m === 'vacation') document.getElementById('modeVacation').classList.add('active');
        if (m === 'half') document.getElementById('modeHalf').classList.add('active');
        if (m === 'sick') document.getElementById('modeSick').classList.add('active');
    },

    renderCalendar() {
        const mStr = document.getElementById('calMonth').value;
        const [y, m] = mStr.split('-');
        const daysInMonth = new Date(y, m, 0).getDate();
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        
        // Wochentage Header
        const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        weekdays.forEach(day => {
            grid.innerHTML += `<div class="cal-header">${day}</div>`;
        });
        
        let firstDay = new Date(y, m - 1, 1).getDay();
        firstDay = (firstDay === 0) ? 6 : firstDay - 1;

        // Leere Zellen vor dem ersten Tag
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div></div>`;
        }
        
        // Tage rendern
        for (let i = 1; i <= daysInMonth; i++) {
            const dKey = `${y}-${m}-${String(i).padStart(2, '0')}`;
            const dayData = this.data.daily[dKey];
            let cls = "cal-day";
            
            const dateObj = new Date(y, m - 1, i);
            const wd = dateObj.getDay();
            
            if (wd === 0 || wd === 6) {
                cls += " weekend";
            }
            
            if (this.isHoliday(dKey)) {
                cls += " holiday";
            } else if (dayData && dayData.type === 'vacation') {
                cls += " vacation";
            } else if (dayData && dayData.type === 'sick') {
                cls += " sick";
            } else if (dayData && dayData.type === 'half') {
                cls += " vacation-half";
            }
            
            const clickable = !this.isHoliday(dKey) && wd !== 0 && wd !== 6;
            
            grid.innerHTML += `<div class="${cls}" ${clickable ? `onclick="app.toggleDay('${dKey}')"` : ''}>${i}</div>`;
        }
    },

    toggleDay(key) {
        const d = new Date(key + 'T00:00:00');
        if (d.getDay() === 0 || d.getDay() === 6) return;
        if (this.isHoliday(key)) return;

        if (!this.data.daily[key]) {
            this.data.daily[key] = { entries: [], type: null };
        }
        
        const currentType = this.data.daily[key].type;
        const newMode = this.state.calMode;
        
        this.data.daily[key].type = (currentType === newMode) ? null : newMode;
        
        console.log(`üìÖ Kalender: ${key} ‚Üí ${this.data.daily[key].type || 'normal'}`);
        
        this.save();
        this.syncToDropbox();
        this.renderCalendar();
        this.calc();
    },

    // SPESEN
    renderSpesenByMonth() {
        const mStr = document.getElementById('spesenMonth').value;
        const [y, m] = mStr.split('-');
        
        const filtered = this.data.spesen.filter(s => s.date.startsWith(`${y}-${m}`));
        const sorted = filtered.sort((a, b) => a.date.localeCompare(b.date));
        
        const l = document.getElementById('spesenList');
        l.innerHTML = "";
        
        if (sorted.length === 0) {
            l.innerHTML = '<p style="color:#ccc; text-align:center; padding:20px; font-size:12px;">Keine Fahrten √ºber 8 Stunden in diesem Zeitraum</p>';
            return;
        }
        
        sorted.forEach((x) => {
            const dateObj = new Date(x.date + 'T00:00:00');
            const dateFormatted = dateObj.toLocaleDateString('de-DE', { 
                weekday: 'short', 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            
            l.innerHTML += `<div class="spesen-day">
                <div class="spesen-day-date">${dateFormatted}</div>
                <div class="spesen-day-time">üïê ${x.start} - ${x.end} Uhr</div>
                <div class="spesen-day-hours">‚è±Ô∏è ${x.hours}h Fahrtzeit</div>
                <button class="btn-red" style="width:100%; margin-top:8px; padding:6px; font-size:12px; margin-bottom:0;" onclick="app.deleteSpesen(${this.data.spesen.indexOf(x)})">üóëÔ∏è L√∂schen</button>
            </div>`;
        });
        
        const totalHours = sorted.reduce((sum, s) => sum + parseFloat(s.hours), 0).toFixed(2);
        l.innerHTML += `<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-top:15px; text-align:center; border-left:4px solid var(--success);">
            <div style="font-size:12px; color:var(--gray); margin-bottom:4px;">GESAMT</div>
            <div style="font-size:18px; font-weight:700; color:var(--success);">${totalHours}h</div>
        </div>`;
    },

    deleteSpesen(idx) {
        if (!confirm('üóëÔ∏è Spesen-Eintrag l√∂schen?')) return;
        
        this.data.spesen.splice(idx, 1);
        console.log(`üóëÔ∏è Spesen gel√∂scht: Index ${idx}`);
        
        this.save();
        this.syncToDropbox();
        this.renderSpesenByMonth();
    },

    exportSpesen() {
        if (this.data.spesen.length === 0) {
            alert('‚ùå Keine Fahrten zum Exportieren');
            return;
        }

        let csv = "Datum;Abfahrt;R√ºckkehr;Stunden\n";
        const sorted = [...this.data.spesen].sort((a, b) => a.date.localeCompare(b.date));
        
        sorted.forEach(x => {
            csv += `${x.date};${x.start};${x.end};${x.hours.replace('.', ',')}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `fahrten_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        
        console.log('üìä CSV exportiert');
    },

    // SETTINGS
    saveSettings() {
        const target = parseFloat(document.getElementById('cfgTarget').value);
        const balance = parseFloat(document.getElementById('cfgBalance').value);
        
        if (isNaN(target) || target < 0 || target > 24) {
            alert('‚ùå Ung√ºltige Sollstunden! Bitte Wert zwischen 0-24 eingeben.');
            return;
        }
        
        this.data.config.target = target;
        this.data.config.balance = balance;
        
        console.log(`‚öôÔ∏è Einstellungen: ${target}h/Tag, Saldo: ${balance}h`);
        
        this.save();
        this.syncToDropbox();
        this.calc();
        alert("‚úÖ Einstellungen gespeichert");
    },

    // BERECHNUNG (Kernlogik)
    calc() {
        let totalBalance = parseFloat(this.data.config.balance) || 0;
        let todayVal = 0;
        let curStatus = 'off';

        const todayKey = this.getLocalDateKey(new Date());
        const target = parseFloat(this.data.config.target) || 7.8;
        const now = new Date();

        // Alle Tage durchgehen
        Object.keys(this.data.daily).sort().forEach(key => {
            const day = this.data.daily[key];
            const isToday = (key === todayKey);
            
            let workSeconds = 0;
            let sessionStart = 0;
            let dayStatus = 'off';
            let prevStatus = 'off';

            day.entries.sort((a, b) => a.time.localeCompare(b.time));

            day.entries.forEach((e) => {
                const [datePart, timePart] = e.time.split('T');
                const [h, m, s] = timePart.split(':').map(Number);
                const ts = new Date(datePart + 'T00:00:00').getTime() + h * 3600000 + m * 60000 + (s || 0) * 1000;
                
                if (e.type === 'office' || e.type === 'drive') {
                    sessionStart = ts;
                    prevStatus = dayStatus;
                    dayStatus = (e.type === 'drive') ? 'driving' : 'office';
                    
                } else if (e.type === 'back') {
                    if (sessionStart > 0) {
                        workSeconds += (ts - sessionStart) / 1000;
                    }
                    sessionStart = 0;
                    dayStatus = 'off';
                    
                } else if (e.type === 'break_start' && (dayStatus === 'office' || dayStatus === 'driving')) {
                    if (sessionStart > 0) {
                        workSeconds += (ts - sessionStart) / 1000;
                    }
                    dayStatus = 'break';
                    
                } else if (e.type === 'break_end' && dayStatus === 'break') {
                    sessionStart = ts;
                    dayStatus = prevStatus;
                }
            });

            // Laufende Session hinzuf√ºgen
            if (isToday && (dayStatus === 'office' || dayStatus === 'driving') && sessionStart > 0) {
                workSeconds += (now.getTime() - sessionStart) / 1000;
            }

            const workHours = workSeconds / 3600;
            let delta = 0;
            
            // Delta berechnen
            if (day.type === 'vacation' || day.type === 'sick') {
                // Urlaub/Krankheit: Gearbeitete Zeit wird als Plus gerechnet
                delta = workHours;
            } else if (day.type === 'half') {
                // Halber Urlaub: Nur halbe Sollzeit abziehen
                delta = workHours - (target / 2);
            } else if (this.isHoliday(key) || this.isWeekend(key)) {
                // Feiertag/Wochenende: Gearbeitete Zeit wird als Plus gerechnet
                delta = workHours;
            } else {
                // Normaler Arbeitstag
                if (day.entries.length > 0 || (isToday && workHours > 0)) {
                    delta = workHours - target;
                }
            }

            totalBalance += delta;

            if (isToday) {
                todayVal = workHours;
                curStatus = dayStatus;
            }
        });

        this.state.status = curStatus;
        
        // UI aktualisieren
        document.getElementById('valToday').innerText = this.formatTime(todayVal);
        
        const balEl = document.getElementById('valTotal');
        balEl.innerText = this.formatTime(totalBalance);
        balEl.className = 'stat-val ' + (totalBalance >= 0 ? 'pos' : 'neg');

        // Status Text
        let statusText = 'Bereit';
        let statusColor = 'var(--gray)';

        if (this.state.currentMode === 'office') {
            statusText = 'üè¢ B√ºro aktiv';
            statusColor = 'var(--info)';
            if (this.state.isOnBreak) {
                statusText += ' <span class="pause-badge">‚è∏Ô∏è PAUSE</span>';
            }
        } else if (this.state.currentMode === 'drive') {
            statusText = 'üöó Fahrt aktiv';
            statusColor = 'var(--purple)';
            if (this.state.isOnBreak) {
                statusText += ' <span class="pause-badge">‚è∏Ô∏è PAUSE</span>';
            }
        }

        const stTxt = document.getElementById('statusDisplay');
        stTxt.innerHTML = statusText;
        stTxt.style.color = statusColor;

        // Controls anzeigen/verstecken
        const modeSelection = document.getElementById('modeSelection');
        const controls = document.getElementById('controls');

        if (this.state.currentMode === null) {
            modeSelection.style.display = 'block';
            controls.style.display = 'none';
        } else {
            modeSelection.style.display = 'none';
            controls.style.display = 'block';

            const switchBtn = document.getElementById('btnSwitch');
            if (this.state.currentMode === 'office') {
                switchBtn.innerHTML = 'üöó ZUR FAHRT';
            } else {
                switchBtn.innerHTML = 'üè¢ ZUM B√úRO';
            }

            const pauseBtn = document.getElementById('btnPause');
            if (this.state.isOnBreak) {
                pauseBtn.innerHTML = '‚ñ∂Ô∏è FORTSETZEN';
                pauseBtn.className = 'btn-green';
            } else {
                pauseBtn.innerHTML = '‚è∏Ô∏è PAUSE';
                pauseBtn.className = 'btn-orange';
            }
        }

        this.renderTimeline(todayKey);
    },

    renderTimeline(key) {
        const list = document.getElementById('timelineList');
        list.innerHTML = "";
        const day = this.data.daily[key];
        
        if (!day || !day.entries.length) {
            list.innerHTML = "<p style='color:#ccc; text-align:center; padding:20px;'>Noch keine Eintr√§ge heute</p>";
            return;
        }
        
        const sorted = [...day.entries].sort((a, b) => a.time.localeCompare(b.time));
        
        sorted.forEach(e => {
            const t = e.time.split('T')[1].slice(0, 5);
            const typeMap = {
                office: 'üè¢ B√ºro Start', 
                drive: 'üöó Fahrt Start', 
                back: '‚èπÔ∏è Session Beendet', 
                break_start: '‚è∏Ô∏è Pause Start', 
                break_end: '‚ñ∂Ô∏è Pause Ende'
            };
            const lbl = typeMap[e.type] || e.type;
            
            const colors = {
                office: 'var(--info)', 
                drive: 'var(--purple)', 
                back: 'var(--danger)', 
                break_start: 'var(--warning)', 
                break_end: 'var(--success)'
            };
            
            list.innerHTML += `<div class="entry-row" style="border-left-color: ${colors[e.type] || 'var(--primary)'};">
                <div class="entry-row-label">
                    <div class="entry-row-label-type" style="color:${colors[e.type] || '#000'};">${lbl}</div>
                    <div class="entry-row-label-time">${t} Uhr</div>
                </div>
            </div>`;
        });
    }
};

// APP STARTEN
if (window.location.search.includes('code=')) {
    // OAuth Callback
    app.init();
    setTimeout(() => app.handleOAuthCallback(), 500);
} else {
    // Normale Initialisierung
    app.init();
}
</script>
</body>
</html>
