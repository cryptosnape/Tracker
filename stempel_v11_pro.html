<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stempel v11 Pro</title>
    <style>
        :root { --primary: #218d8f; --bg: #f2f2f7; --card: #ffffff; --text: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
        
        .header { background: var(--card); padding: 15px; text-align: center; border-bottom: 1px solid #c6c6c8; position: sticky; top: 0; z-index: 100; }
        .time-big { font-size: 32px; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--primary); }
        .date-small { font-size: 13px; color: #8e8e93; margin-top: 4px; }

        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        h2 { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; }

        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; margin-bottom: 10px; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-green { background: #34c759; color: white; }
        .btn-red { background: #ff3b30; color: white; }
        .btn-orange { background: #ff9500; color: white; }
        .btn-blue { background: #007aff; color: white; }
        .btn-gray { background: #e5e5ea; color: #000; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #f2f2f7; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-lbl { font-size: 11px; color: #8e8e93; text-transform: uppercase; }
        .stat-val { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .stat-val.pos { color: #34c759; }
        .stat-val.neg { color: #ff3b30; }

        .entry-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .entry-row:last-child { border-bottom: none; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: #8e8e93; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #c6c6c8; font-size: 16px; background: #fff; -webkit-appearance: none; }

        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #f2f2f7; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .cal-day.vacation { background: rgba(52, 199, 89, 0.2); color: #2d8a3e; font-weight: bold; border: 1px solid #34c759; }
        .cal-day.sick { background: rgba(255, 149, 0, 0.2); color: #d97706; font-weight: bold; border: 1px solid #ff9500; }
        .cal-day.vacation-half { background: linear-gradient(135deg, rgba(52, 199, 89, 0.2) 50%, #f2f2f7 50%); color: #2d8a3e; font-weight: bold; border: 1px solid #34c759; }
        .cal-day.holiday { background: rgba(255, 59, 48, 0.2); color: #c2185b; font-weight: bold; border: 1px solid #ff3b30; cursor: not-allowed; opacity: 0.6; }
        .cal-day.weekend { color: #ccc; pointer-events: none; background: #fff; }

        .cal-mode-btn { flex: 1; font-size: 12px; padding: 8px; border-radius: 6px; border: none; background: #e5e5ea; color: #000; cursor: pointer; }
        .cal-mode-btn.active { background: var(--primary); color: white; }

        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid #c6c6c8; display: flex; padding-bottom: env(safe-area-inset-bottom); height: 80px; z-index: 200; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8e8e93; font-size: 10px; font-weight: 500; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }

        .warning-box { background: #fef3c7; border: 1px solid #fcd34d; padding: 12px; border-radius: 8px; color: #92400e; font-size: 13px; margin-bottom: 15px; }
        .error-box { background: #fee2e2; border: 1px solid #fca5a5; padding: 12px; border-radius: 8px; color: #991b1b; font-size: 13px; margin-bottom: 15px; }
        .success-box { background: #dcfce7; border: 1px solid #86efac; padding: 12px; border-radius: 8px; color: #166534; font-size: 13px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="header">
    <div class="time-big" id="clock">00:00:00</div>
    <div class="date-small" id="dateDisplay">-</div>
</div>

<!-- PAGE 1: WORK -->
<div id="page-work" class="page active">
    <div class="card">
        <div id="warningBox"></div>
        <div id="statusDisplay" style="text-align:center; margin-bottom:15px; font-weight:600; color:#8e8e93;">Bereit</div>
        
        <button class="btn-green" id="btnIn" onclick="app.doAction('in')">KOMMEN</button>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn-orange" id="btnBreakStart" onclick="app.doAction('break_start')" disabled>PAUSE START</button>
            <button class="btn-orange" id="btnBreakEnd" onclick="app.doAction('break_end')" disabled>PAUSE ENDE</button>
        </div>
        <button class="btn-red" id="btnOut" onclick="app.doAction('out')" disabled>GEHEN</button>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-lbl">Heute</div>
                <div class="stat-val" id="valToday">0:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">Konto (Gesamt)</div>
                <div class="stat-val" id="valTotal">0:00</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Verlauf Heute</h2>
        <div id="timelineList"></div>
    </div>
</div>

<!-- PAGE 2: EDITOR -->
<div id="page-editor" class="page">
    <div class="card">
        <h2>Zeiten korrigieren</h2>
        <div class="input-group">
            <input type="date" id="editorDate" onchange="app.loadEditor()">
        </div>
        <div id="editorValidation"></div>
        <div id="editorList"></div>
        <button class="btn-blue" onclick="app.showAddModal()" style="margin-top:15px;">+ Neuer Eintrag</button>
    </div>
</div>

<!-- PAGE 3: CALENDAR -->
<div id="page-calendar" class="page">
    <div class="card">
        <h2>Urlaub & Krankheit</h2>
        <div class="input-group">
            <input type="month" id="calMonth" onchange="app.renderCalendar()">
        </div>
        
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="cal-mode-btn active" id="modeVacation" onclick="app.setCalMode('vacation')" style="flex:1; font-size:12px; padding:8px;">Urlaub (1.0)</button>
            <button class="cal-mode-btn" id="modeHalf" onclick="app.setCalMode('half')" style="flex:1; font-size:12px; padding:8px;">Urlaub (0.5)</button>
            <button class="cal-mode-btn" id="modeSick" onclick="app.setCalMode('sick')" style="flex:1; font-size:12px; padding:8px;">Krank</button>
        </div>

        <div id="calendarGrid" class="calendar"></div>
        <p style="font-size:12px; color:#888; margin-top:10px; text-align:center;">Feiertage & Wochenenden grau.<br>Klicke auf andere Tage zum Markieren.</p>
    </div>
</div>

<!-- PAGE 4: SPESEN -->
<div id="page-spesen" class="page">
    <div class="card">
        <h2>Spesen erfassen</h2>
        <div class="input-group">
            <label>Datum</label>
            <input type="date" id="spesenDate">
        </div>
        <div class="input-group">
            <label>Abfahrt</label>
            <input type="time" id="spesenStart">
        </div>
        <div class="input-group">
            <label>R√ºckkehr</label>
            <input type="time" id="spesenEnd">
        </div>
        <button class="btn-blue" onclick="app.saveSpesen()">SPEICHERN</button>
    </div>
    
    <div class="card">
        <h2>Export</h2>
        <button class="btn-gray" onclick="app.exportSpesen()">CSV Datei erstellen</button>
        <div id="spesenList" style="margin-top:15px;"></div>
    </div>
</div>

<!-- PAGE 5: SETTINGS -->
<div id="page-settings" class="page">
    <div class="card">
        <h2>Einstellungen</h2>
        <div class="input-group">
            <label>Sollstunden / Tag</label>
            <input type="number" id="cfgTarget" value="7.8" step="0.1">
        </div>
        <div class="input-group">
            <label>Start-Saldo (Stunden)</label>
            <input type="number" id="cfgBalance" value="0" step="0.1">
        </div>
        <button class="btn-green" onclick="app.saveSettings()">Speichern</button>
        
        <button class="btn-red" style="margin-top:30px;" onclick="app.resetAll()">Alles l√∂schen</button>
    </div>
</div>

<!-- NAV BAR -->
<div class="nav">
    <div class="nav-item active" onclick="app.nav('work')" id="nav-work"><span class="nav-icon">‚è±Ô∏è</span>Zeit</div>
    <div class="nav-item" onclick="app.nav('editor')" id="nav-editor"><span class="nav-icon">‚úèÔ∏è</span>Edit</div>
    <div class="nav-item" onclick="app.nav('calendar')" id="nav-calendar"><span class="nav-icon">üìÖ</span>Plan</div>
    <div class="nav-item" onclick="app.nav('spesen')" id="nav-spesen"><span class="nav-icon">üöó</span>Spesen</div>
    <div class="nav-item" onclick="app.nav('settings')" id="nav-settings"><span class="nav-icon">‚öôÔ∏è</span>Setup</div>
</div>

<!-- MODAL ADD ENTRY -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h3>Eintrag hinzuf√ºgen</h3>
        <br>
        <label>Typ</label>
        <select id="addType" style="margin-bottom:10px;">
            <option value="in">Kommen</option>
            <option value="out">Gehen</option>
            <option value="break_start">Pause Start</option>
            <option value="break_end">Pause Ende</option>
        </select>
        <label>Zeit</label>
        <input type="time" id="addTime" style="margin-bottom:15px;">
        <button class="btn-green" onclick="app.addManualEntry()">Hinzuf√ºgen</button>
        <button class="btn-gray" onclick="document.getElementById('addModal').classList.remove('active')">Abbrechen</button>
    </div>
</div>

<script>
const app = {
    data: {
        daily: {},
        spesen: [],
        config: { target: 7.8, balance: 0 }
    },
    state: { 
        status: 'off', 
        calMode: 'vacation'
    },

    hessenHolidays: [
        '2025-01-01', '2025-04-18', '2025-04-21', '2025-05-01', '2025-05-29', '2025-06-09', '2025-06-19', '2025-10-03', '2025-12-25', '2025-12-26',
        '2026-01-01', '2026-04-03', '2026-04-06', '2026-05-01', '2026-05-14', '2026-05-25', '2026-06-04', '2026-10-03', '2026-12-25', '2026-12-26',
        '2027-01-01', '2027-03-26', '2027-03-29', '2027-05-01', '2027-05-06', '2027-05-17', '2027-05-27', '2027-10-03', '2027-12-25', '2027-12-26',
        '2028-01-01', '2028-04-14', '2028-04-17', '2028-05-01', '2028-05-25', '2028-06-05', '2028-06-15', '2028-10-03', '2028-12-25', '2028-12-26',
        '2029-01-01', '2029-03-30', '2029-04-02', '2029-05-01', '2029-05-10', '2029-05-21', '2029-05-31', '2029-10-03', '2029-12-25', '2029-12-26',
        '2030-01-01', '2030-04-19', '2030-04-22', '2030-05-01', '2030-05-30', '2030-06-10', '2030-06-20', '2030-10-03', '2030-12-25', '2030-12-26',
        '2031-01-01', '2031-04-11', '2031-04-14', '2031-05-01', '2031-05-22', '2031-06-02', '2031-06-12', '2031-10-03', '2031-12-25', '2031-12-26',
        '2032-01-01', '2032-03-26', '2032-03-29', '2032-05-01', '2032-05-13', '2032-05-24', '2032-06-03', '2032-10-03', '2032-12-25', '2032-12-26',
        '2033-01-01', '2033-04-15', '2033-04-18', '2033-05-01', '2033-06-02', '2033-06-13', '2033-06-23', '2033-10-03', '2033-12-25', '2033-12-26',
        '2034-01-01', '2034-04-07', '2034-04-10', '2034-05-01', '2034-05-25', '2034-06-05', '2034-06-15', '2034-10-03', '2034-12-25', '2034-12-26',
        '2035-01-01', '2035-03-23', '2035-03-26', '2035-05-01', '2035-05-10', '2035-05-21', '2035-05-31', '2035-10-03', '2035-12-25', '2035-12-26',
        '2036-01-01', '2036-04-11', '2036-04-14', '2036-05-01', '2036-05-29', '2036-06-09', '2036-06-19', '2036-10-03', '2036-12-25', '2036-12-26',
        '2037-01-01', '2037-04-03', '2037-04-06', '2037-05-01', '2037-05-14', '2037-05-25', '2037-06-04', '2037-10-03', '2037-12-25', '2037-12-26',
        '2038-01-01', '2038-04-23', '2038-04-26', '2038-05-01', '2038-06-03', '2038-06-14', '2038-06-24', '2038-10-03', '2038-12-25', '2038-12-26',
        '2039-01-01', '2039-04-08', '2039-04-11', '2039-05-01', '2039-05-26', '2039-06-06', '2039-06-16', '2039-10-03', '2039-12-25', '2039-12-26',
        '2040-01-01', '2040-03-30', '2040-04-02', '2040-05-01', '2040-05-17', '2040-05-28', '2040-06-07', '2040-10-03', '2040-12-25', '2040-12-26',
        '2041-01-01', '2041-04-19', '2041-04-22', '2041-05-01', '2041-06-06', '2041-06-17', '2041-06-27', '2041-10-03', '2041-12-25', '2041-12-26',
        '2042-01-01', '2042-04-04', '2042-04-07', '2042-05-01', '2042-05-22', '2042-06-02', '2042-06-12', '2042-10-03', '2042-12-25', '2042-12-26',
        '2043-01-01', '2043-03-27', '2043-03-30', '2043-05-01', '2043-05-14', '2043-05-25', '2043-06-04', '2043-10-03', '2043-12-25', '2043-12-26',
        '2044-01-01', '2044-04-15', '2044-04-18', '2044-05-01', '2044-06-02', '2044-06-13', '2044-06-23', '2044-10-03', '2044-12-25', '2044-12-26',
        '2045-01-01', '2045-04-07', '2045-04-10', '2045-05-01', '2045-05-25', '2045-06-05', '2045-06-15', '2045-10-03', '2045-12-25', '2045-12-26',
        '2046-01-01', '2046-03-23', '2046-03-26', '2046-05-01', '2046-05-10', '2046-05-21', '2046-05-31', '2046-10-03', '2046-12-25', '2046-12-26',
        '2047-01-01', '2047-04-12', '2047-04-15', '2047-05-01', '2047-05-30', '2047-06-10', '2047-06-20', '2047-10-03', '2047-12-25', '2047-12-26',
        '2048-01-01', '2048-04-03', '2048-04-06', '2048-05-01', '2048-05-15', '2048-05-26', '2048-06-05', '2048-10-03', '2048-12-25', '2048-12-26',
        '2049-01-01', '2049-04-23', '2049-04-26', '2049-05-01', '2049-06-03', '2049-06-14', '2049-06-24', '2049-10-03', '2049-12-25', '2049-12-26',
        '2050-01-01', '2050-04-08', '2050-04-11', '2050-05-01', '2050-05-26', '2050-06-06', '2050-06-16', '2050-10-03', '2050-12-25', '2050-12-26',
        '2051-01-01', '2051-03-31', '2051-04-03', '2051-05-01', '2051-05-18', '2051-05-29', '2051-06-08', '2051-10-03', '2051-12-25', '2051-12-26',
        '2052-01-01', '2052-04-19', '2052-04-22', '2052-05-01', '2052-06-06', '2052-06-17', '2052-06-27', '2052-10-03', '2052-12-25', '2052-12-26',
        '2053-01-01', '2053-04-04', '2053-04-07', '2053-05-01', '2053-05-22', '2053-06-02', '2053-06-12', '2053-10-03', '2053-12-25', '2053-12-26',
        '2054-01-01', '2054-03-27', '2054-03-30', '2054-05-01', '2054-05-14', '2054-05-25', '2054-06-04', '2054-10-03', '2054-12-25', '2054-12-26',
        '2055-01-01', '2055-04-16', '2055-04-19', '2055-05-01', '2055-06-03', '2055-06-14', '2055-06-24', '2055-10-03', '2055-12-25', '2055-12-26'
    ],

    init() {
        const s = localStorage.getItem('stempel_v11_pro');
        if(s) {
            try { this.data = JSON.parse(s); } 
            catch(e) { console.error("Data Load Error", e); }
        }

        setInterval(() => this.tick(), 1000);
        this.tick();

        document.getElementById('editorDate').valueAsDate = new Date();
        document.getElementById('spesenDate').valueAsDate = new Date();
        document.getElementById('calMonth').value = new Date().toISOString().slice(0,7);
        
        document.getElementById('cfgTarget').value = this.data.config.target;
        document.getElementById('cfgBalance').value = this.data.config.balance;

        this.calc();
        this.renderCalendar();
    },

    save() {
        localStorage.setItem('stempel_v11_pro', JSON.stringify(this.data));
    },

    validateEntries(dateKey) {
        const day = this.data.daily[dateKey];
        if(!day || !day.entries.length) return { valid: true, errors: [] };

        const errors = [];
        day.entries.sort((a,b) => a.time.localeCompare(b.time));

        for(let i = 0; i < day.entries.length; i++) {
            const e = day.entries[i];
            const next = i+1 < day.entries.length ? day.entries[i+1] : null;

            if(e.type === 'in' && next && (next.type === 'in')) {
                errors.push(`‚ö†Ô∏è Doppel-KOMMEN um ${e.time.split('T')[1].slice(0,5)} & ${next.time.split('T')[1].slice(0,5)}`);
            }
            if(e.type === 'break_start' && next && (next.type === 'break_start')) {
                errors.push(`‚ö†Ô∏è Doppel-PAUSE START um ${e.time.split('T')[1].slice(0,5)}`);
            }
            if(e.type === 'break_start' && next && (next.type === 'in')) {
                errors.push(`‚ö†Ô∏è PAUSE START ohne PAUSE ENDE um ${e.time.split('T')[1].slice(0,5)}`);
            }
        }

        return { valid: errors.length === 0, errors };
    },

    checkWarnings() {
        const todayKey = this.getDateKey(new Date());
        const today = this.data.daily[todayKey];
        let warningHTML = '';
        
        if(!today || !today.entries.length) {
            document.getElementById('warningBox').innerHTML = '';
            return;
        }

        const lastEntry = today.entries[today.entries.length - 1];
        if(lastEntry.type === 'in' || lastEntry.type === 'break_end') {
            const lastTime = new Date(lastEntry.time);
            const now = new Date();
            const hoursOpen = (now - lastTime) / 1000 / 3600;

            if(hoursOpen > 14) {
                warningHTML += `<div class="error-box">‚ùå Eingestempelt seit ${Math.floor(hoursOpen)}h! Bitte korrigieren im Editor.</div>`;
            }
        }

        if(lastEntry.type === 'break_start') {
            const lastTime = new Date(lastEntry.time);
            const now = new Date();
            const hoursBreak = (now - lastTime) / 1000 / 3600;

            if(hoursBreak > 2) {
                warningHTML += `<div class="error-box">‚ùå Pause seit ${Math.floor(hoursBreak)}h! Dr√ºcke PAUSE ENDE.</div>`;
            }
        }

        document.getElementById('warningBox').innerHTML = warningHTML;
    },

    nav(id) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
        
        if(id === 'editor') this.loadEditor();
        if(id === 'calendar') this.renderCalendar();
        if(id === 'spesen') this.renderSpesenList();
    },

    tick() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('de-DE');
        document.getElementById('dateDisplay').innerText = now.toLocaleDateString('de-DE', {weekday:'long', day:'numeric', month:'short'});
        
        if(this.state.status === 'working' || this.state.status === 'break') {
            this.calc();
        }

        this.checkWarnings();
    },

    getLastEntryType() {
        const todayKey = this.getDateKey(new Date());
        const today = this.data.daily[todayKey];
        if(!today || !today.entries.length) return null;
        return today.entries[today.entries.length - 1].type;
    },

    doAction(type) {
        const lastType = this.getLastEntryType();

        if(type === 'in' && (lastType === 'in' || lastType === 'break_end')) {
            alert('‚ùå Du bist bereits am Arbeiten! Dr√ºcke zuerst GEHEN.');
            return;
        }
        if(type === 'out' && lastType !== 'in' && lastType !== 'break_end') {
            alert('‚ùå Du musst zuerst KOMMEN dr√ºcken.');
            return;
        }
        if(type === 'break_start' && lastType !== 'in') {
            alert('‚ùå Du musst zuerst KOMMEN dr√ºcken.');
            return;
        }
        if(type === 'break_end' && lastType !== 'break_start') {
            alert('‚ùå Du musst zuerst PAUSE START dr√ºcken.');
            return;
        }

        const today = this.getDateKey(new Date());
        if(!this.data.daily[today]) this.data.daily[today] = { entries: [] };
        
        const now = new Date();
        const localTimeStr = `${today}T${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        this.data.daily[today].entries.push({ type: type, time: localTimeStr });
        this.data.daily[today].entries.sort((a,b) => a.time.localeCompare(b.time));

        this.save();
        this.calc();
    },

    isHoliday(dateStr) {
        return this.hessenHolidays.includes(dateStr);
    },

    isWeekend(dateStr) {
        const d = new Date(dateStr);
        const wd = d.getDay();
        return (wd === 0 || wd === 6);
    },

    calc() {
        let totalBalance = parseFloat(this.data.config.balance) || 0;
        let todayVal = 0;
        let curStatus = 'off';

        const todayKey = this.getDateKey(new Date());
        const target = parseFloat(this.data.config.target) || 7.8;
        const now = new Date();

        // FIX 1: KUMULATIVER SALDO (nicht nur heute)
        Object.keys(this.data.daily).sort().forEach(key => {
            const day = this.data.daily[key];
            const isToday = (key === todayKey);
            
            let workSeconds = 0;
            let lastIn = 0;
            let dayStatus = 'off';

            day.entries.sort((a,b) => a.time.localeCompare(b.time));

            day.entries.forEach(e => {
                // FIX 2: Keine new Date() Parsing - nur String-Verarbeitung
                const [datePart, timePart] = e.time.split('T');
                const [h, m, s] = timePart.split(':').map(Number);
                const ts = new Date(datePart).getTime() + h*3600000 + m*60000 + s*1000;
                
                if(e.type === 'in' || e.type === 'break_end') {
                    lastIn = ts;
                    dayStatus = 'working';
                } else if((e.type === 'out' || e.type === 'break_start') && dayStatus === 'working') {
                    if(lastIn > 0) workSeconds += (ts - lastIn);
                    lastIn = 0;
                    dayStatus = (e.type === 'break_start') ? 'break' : 'off';
                }
            });

            if(isToday && dayStatus === 'working' && lastIn > 0) {
                workSeconds += (now.getTime() - lastIn);
            }

            const workHours = workSeconds / 1000 / 3600;

            let delta = 0;
            
            if (day.type === 'vacation' || day.type === 'sick') {
                delta = workHours;
            } else if (day.type === 'half') {
                delta = workHours - (target / 2);
            } else if (this.isHoliday(key) || this.isWeekend(key)) {
                delta = workHours;
            } else {
                if(day.entries.length > 0 || (isToday && workHours > 0)) {
                    delta = workHours - target;
                }
            }

            totalBalance += delta;

            if(isToday) {
                todayVal = workHours;
                curStatus = dayStatus;
            }
        });

        this.state.status = curStatus;
        
        document.getElementById('valToday').innerText = this.fmt(todayVal);
        const balEl = document.getElementById('valTotal');
        balEl.innerText = this.fmt(totalBalance);
        balEl.className = 'stat-val ' + (totalBalance >= 0 ? 'pos' : 'neg');
        
        const stTxt = document.getElementById('statusDisplay');
        if(curStatus === 'working') { stTxt.innerText = "Am Arbeiten ..."; stTxt.style.color="#34c759"; }
        else if(curStatus === 'break') { stTxt.innerText = "In Pause ‚òï"; stTxt.style.color="#ff9500"; }
        else { stTxt.innerText = "Bereit"; stTxt.style.color="#8e8e93"; }

        document.getElementById('btnIn').disabled = (curStatus !== 'off');
        document.getElementById('btnOut').disabled = (curStatus === 'off');
        document.getElementById('btnBreakStart').disabled = (curStatus !== 'working');
        document.getElementById('btnBreakEnd').disabled = (curStatus !== 'break');

        this.renderTimeline(todayKey);
    },

    renderTimeline(key) {
        const list = document.getElementById('timelineList');
        list.innerHTML = "";
        const day = this.data.daily[key];
        if(!day || !day.entries.length) {
            list.innerHTML = "<div style='text-align:center; color:#ccc; font-size:13px; padding:10px;'>Noch keine Eintr√§ge heute</div>";
            return;
        }
        
        [...day.entries].sort((a,b) => b.time.localeCompare(a.time)).forEach(e => {
            const timeParts = e.time.split('T')[1];
            const t = timeParts ? timeParts.slice(0,5) : '--:--';
            let lbl = "UNBEKANNT";
            let col = "#000";
            if(e.type === 'in') { lbl = "KOMMEN"; col = "#34c759"; }
            if(e.type === 'out') { lbl = "GEHEN"; col = "#ff3b30"; }
            if(e.type === 'break_start') { lbl = "PAUSE START"; col = "#ff9500"; }
            if(e.type === 'break_end') { lbl = "PAUSE ENDE"; col = "#ff9500"; }
            
            list.innerHTML += `<div class="entry-row">
                <span style="color:${col}; font-weight:600;">${lbl}</span>
                <b>${t}</b>
            </div>`;
        });
    },

    loadEditor() {
        const d = document.getElementById('editorDate').value;
        const list = document.getElementById('editorList');
        const valDiv = document.getElementById('editorValidation');
        list.innerHTML = "";
        valDiv.innerHTML = "";
        
        // FIX 3: Validierung beim Editor-√ñffnen
        const validation = this.validateEntries(d);
        if(!validation.valid) {
            let errHTML = '<div class="error-box">‚ö†Ô∏è Fehler in dieser Datei:<br>';
            validation.errors.forEach(err => errHTML += `‚Ä¢ ${err}<br>`);
            errHTML += '</div>';
            valDiv.innerHTML = errHTML;
        } else if(this.data.daily[d] && this.data.daily[d].entries.length > 0) {
            valDiv.innerHTML = '<div class="success-box">‚úì Eintr√§ge sind konsistent.</div>';
        }
        
        if(!this.data.daily[d] || !this.data.daily[d].entries.length) {
            list.innerHTML = "<p style='color:#ccc; text-align:center; padding:10px;'>Keine Eintr√§ge an diesem Tag</p>";
            return;
        }

        this.data.daily[d].entries.sort((a,b) => a.time.localeCompare(b.time)).forEach((e, idx) => {
            const timeParts = e.time.split('T')[1];
            const t = timeParts ? timeParts.slice(0,5) : '--:--';
            let lbl = e.type.toUpperCase();
            list.innerHTML += `
            <div class="entry-row">
                <span>${lbl}</span>
                <span>${t}</span>
                <button class="btn-red" style="width:auto; padding:6px 12px; font-size:12px; margin:0;" onclick="app.deleteEntry('${d}', ${idx})">L√∂schen</button>
            </div>`;
        });
    },

    deleteEntry(date, idx) {
        if(!confirm("Eintrag wirklich l√∂schen?")) return;
        this.data.daily[date].entries.splice(idx, 1);
        this.save();
        this.loadEditor();
        this.calc();
    },

    showAddModal() { document.getElementById('addModal').classList.add('active'); },

    addManualEntry() {
        const d = document.getElementById('editorDate').value;
        const t = document.getElementById('addTime').value;
        const type = document.getElementById('addType').value;
        
        if(!t) { alert("Bitte Uhrzeit w√§hlen"); return; }
        
        if(!this.data.daily[d]) this.data.daily[d] = { entries: [] };
        
        const localTimeStr = `${d}T${t}:00`;
        
        this.data.daily[d].entries.push({ type: type, time: localTimeStr });
        this.data.daily[d].entries.sort((a,b) => a.time.localeCompare(b.time));
        
        this.save();
        document.getElementById('addModal').classList.remove('active');
        this.loadEditor();
        this.calc();
    },

    setCalMode(m) {
        this.state.calMode = m;
        document.querySelectorAll('.cal-mode-btn').forEach(b => b.classList.remove('active'));
        if(m==='vacation') document.getElementById('modeVacation').classList.add('active');
        if(m==='half') document.getElementById('modeHalf').classList.add('active');
        if(m==='sick') document.getElementById('modeSick').classList.add('active');
    },

    renderCalendar() {
        const mStr = document.getElementById('calMonth').value;
        const [y, m] = mStr.split('-');
        const daysInMonth = new Date(y, m, 0).getDate();
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        
        let firstDay = new Date(y, m-1, 1).getDay();
        firstDay = (firstDay === 0) ? 6 : firstDay - 1;

        for(let i=0; i<firstDay; i++) {
            grid.innerHTML += `<div style="background:transparent;"></div>`;
        }
        
        for(let i=1; i<=daysInMonth; i++) {
            const dKey = `${y}-${m}-${String(i).padStart(2,'0')}`;
            const dayData = this.data.daily[dKey];
            let cls = "cal-day";
            
            const dateObj = new Date(y, m-1, i);
            const wd = dateObj.getDay();
            if(wd===0 || wd===6) cls += " weekend";
            
            if(this.isHoliday(dKey)) {
                cls += " holiday";
            } else if(dayData && dayData.type === 'vacation') {
                cls += " vacation";
            } else if(dayData && dayData.type === 'sick') {
                cls += " sick";
            } else if(dayData && dayData.type === 'half') {
                cls += " vacation-half";
            }
            
            grid.innerHTML += `<div class="${cls}" ${!this.isHoliday(dKey) && wd!==0 && wd!==6 ? `onclick="app.toggleDay('${dKey}')"` : ''}>${i}</div>`;
        }
    },

    toggleDay(key) {
        const d = new Date(key);
        if(d.getDay()===0 || d.getDay()===6) return;
        if(this.isHoliday(key)) return;

        if(!this.data.daily[key]) this.data.daily[key] = { entries: [] };
        
        const currentType = this.data.daily[key].type;
        const newMode = this.state.calMode;
        
        if(currentType === newMode) {
            this.data.daily[key].type = null;
        } else {
            this.data.daily[key].type = newMode;
        }
        
        this.save();
        this.renderCalendar();
        this.calc();
    },

    saveSpesen() {
        const d = document.getElementById('spesenDate').value;
        const s = document.getElementById('spesenStart').value;
        const e = document.getElementById('spesenEnd').value;
        
        if(!d || !s || !e) { alert("Bitte alles ausf√ºllen"); return; }
        if(e < s) { alert("R√ºckkehr kann nicht vor Abfahrt sein!"); return; }
        
        this.data.spesen.push({ date: d, start: s, end: e });
        this.save();
        this.renderSpesenList();
        alert("Fahrt gespeichert");
    },

    renderSpesenList() {
        const l = document.getElementById('spesenList');
        l.innerHTML = "";
        if(this.data.spesen.length === 0) {
            l.innerHTML = "<div style='text-align:center; color:#ccc; font-size:12px;'>Keine Fahrten</div>";
            return;
        }
        
        [...this.data.spesen].sort((a,b) => b.date.localeCompare(a.date)).forEach(x => {
            const diff = (new Date("1970-01-01T"+x.end) - new Date("1970-01-01T"+x.start)) / 1000 / 3600;
            l.innerHTML += `<div class="entry-row">
                <div><b>${x.date}</b><br>${x.start} - ${x.end}</div>
                <div>${diff.toFixed(2)}h</div>
            </div>`;
        });
    },

    exportSpesen() {
        let csv = "Datum;Start;Ende;Stunden\n";
        this.data.spesen.forEach(x => {
            const diff = (new Date("1970-01-01T"+x.end) - new Date("1970-01-01T"+x.start)) / 1000 / 3600;
            csv += `${x.date};${x.start};${x.end};${diff.toFixed(2).replace('.',',')}\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "spesen_export.csv";
        a.click();
    },

    saveSettings() {
        this.data.config.target = parseFloat(document.getElementById('cfgTarget').value);
        this.data.config.balance = parseFloat(document.getElementById('cfgBalance').value);
        this.save();
        this.calc();
        alert("Einstellungen gespeichert");
    },

    resetAll() {
        if(confirm("ACHTUNG: Wirklich ALLES l√∂schen?")) {
            localStorage.clear();
            location.reload();
        }
    },

    getDateKey(d) { return d.toISOString().split('T')[0]; },
    fmt(n) {
        let h = Math.floor(Math.abs(n));
        let m = Math.round((Math.abs(n)-h)*60);
        return (n<0?"-":"") + h + ":" + (m<10?"0":"") + m;
    }
};

app.init();
</script>
</body>
</html>